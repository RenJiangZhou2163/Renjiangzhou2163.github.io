
## 1.7 IP路由

### 1.7.1 IGP公共的配置规范

#### 1.7.1.1 IGP邻居超时时间配置规范

IGP协议（OSPF、ISIS）配置的邻居超时时间过短，可能会导致邻居容易超时Down而影响业务。

##### 应用场景

设备使能了相关IGP协议（比如OSPF、ISIS）。

##### 配置规范

建议采用**ospf timer dead** *interval*命令缺省的邻居的超时时间。

##### 非规范配置的风险

**风险描述**

- 对于使能了IS-IS的接口，若其接口视图下配置了**isis timer hello** **3**命令且未配置**isis timer holding-multiplier** *number*命令，则认为其配置了过短的邻居超时时间。
- 对于使能了OSPF的接口，满足以下任一条件则认为其配置了过短的邻居超时时间：
  - 接口视图下配置了**ospf timer hello** **1**命令且没有配置**ospf timer dead** *interval*命令。
  - 接口视图下配置了**ospf timer dead** *interval*命令，且*interval*取值不大于4。

当满足上述任意一个条件时，可能会导致邻居超时Down，进而影响业务。

**风险的判断方法**

1. 查询是否使能了IGP协议（OSPF、ISIS）。

   \# 在任意视图下执行**display current-configuration configuration** **isis**命令和**display current-configuration configuration** **ospf**命令，查看是否存在相关协议的的配置信息。

   ```
   <HUAWEI> display current-configuration configuration isis

   #

   isis 100

    is-level level-2

    cost-style wide

    network-entity 10.0000.0100.0005.00

   #

   

   <HUAWEI> display current-configuration configuration ospf 

   #

   ospf 100

    area 0.0.0.0

     network 31.1.1.0 0.0.0.255

     network 12.3.3.0 0.0.0.255

   #
   ```

2. 查询使能了IGP协议（OSPF、ISIS）的接口。

   \# 在任意视图下执行**display isis interface verbose**命令，查询使能了ISIS协议的接口。下面显示信息中，**GigabitEthernet3/0/6.1001**接口使能了ISIS协议。

   ```
   <HUAWEI> display isis interface verbose 

   

                         Interface information for ISIS(100)

                         -----------------------------------

    Interface       Id      IPV4.State          IPV6.State      MTU  Type  DIS   

    GE3/0/6.1001    001         Up                 Down         1497 L1/L2 -- 

     Circuit MT State            : Standard 

     Circuit Parameters          : p2p 

     Description                 : HUAWEI, GigabitEthernet3/0/6.1001 Interface

     SNPA Address                : 0018-8266-56be

     IP Address                  : 26.1.1.5

     IPV6 Link Local Address     :

     IPV6 Global Address(es)     :

     Csnp Timer Value            :  L12   10

     Hello Timer Value           :        10

     DIS Hello Timer Value       :

     Hello Multiplier Value      :      1000

     LSP-Throttle Timer          :  L12   50

     Cost                        :  L1    10  L2    10

     Ipv6 Cost                   :  L1    10  L2    10

     Retransmit Timer Value      :  L12    5

     Bandwidth-Value             :  Low 1000000000  High          0

     Static Bfd                  :  NO

     Dynamic Bfd                 :  NO

     Dynamic IPv6 Bfd            :  NO

     Fast-Sense Rpr              :  NO

     Extended-Circuit-Id Value   :  0000000001

     Suppress Base               :  NO

     IPv6 Suppress Base          :  NO

     Link quality adjust cost    :  NO

   Link quality                :  0x0(Best)

   
   ```

   \# 在任意视图下执行**display ospf interface all**命令，查询使能了OSPF协议的接口。下面显示信息中，**GigabitEthernet3/0/4**和**GigabitEthernet3/0/9**接口使能了OSPF协议。

   ```
   <HUAWEI> display ospf interface all

   

            OSPF Process 100 with Router ID 20.1.1.2

                    Interfaces 

   

    Area: 0.0.0.0          (MPLS TE not enabled)

   
   ```

   Interface: 12.3.3.1 (**GigabitEthernet3/0/4**)

   ```
    Cost: 1       State: BDR       Type: Broadcast    MTU: 1500  

    Priority: 1

    Designated Router: 12.3.3.2

    Backup Designated Router: 12.3.3.1

    Timers: Hello 10 , Dead 40 , Poll  120 , Retransmit 5 , Transmit Delay 1 

   

    Interface: 31.1.1.1 (GigabitEthernet3/0/9)  

    Cost: 1       State: DR        Type: Broadcast    MTU: 1500  

    Priority: 1

    Designated Router: 31.1.1.1

    Backup Designated Router: 31.1.1.2

    Timers: Hello 10 , Dead 40 , Poll  120 , Retransmit 5 , Transmit Delay 1
   ```

3. 查询是否配置了过短的邻居超时时间。

   对于使能了ISIS的接口，若其接口视图下配置了**isis timer hello** **3**命令且未配置**isis timer holding-multiplier** *number*命令，则认为其配置了过短的邻居超时时间。

   对于使能了OSPF的接口，满足以下任一条件则认为其配置了过短的邻居超时时间：

   （1）接口视图下配置了**ospf timer hello** **1**命令且没有配置**ospf timer dead** *interval*命令。

   （2）接口视图下配置了**ospf timer dead** *interval*命令，且*interval*取值不大于4。

   \# 查看GigabitEthernet3/0/6.1001接口，该接口配置了过短的邻居超时时间。

   ```
   <HUAWEI> display current-configuration interface GigabitEthernet3/0/6.1001

   #

   interface GigabitEthernet3/0/6.1001

    vlan-type dot1q 1001

    ip address 26.1.1.5 255.255.255.0

    isis enable 100

    isis circuit-type p2p

    isis timer hello 3

   #

   return
   ```

   \# 查看GigabitEthernet3/0/4接口，该接口配置了过短的邻居超时时间。

   ```
   <HUAWEI> display current-configuration interface GigabitEthernet3/0/4

   #

   interface GigabitEthernet3/0/4

    undo shutdown

    ip address 12.3.3.1 255.255.255.0

    ospf timer hello 1   

   #

   return
   ```

   \# 查看GigabitEthernet3/0/9接口，该接口配置了过短的邻居超时时间。

   ```
   <HUAWEI> display current-configuration interface GigabitEthernet3/0/9

   #

   interface GigabitEthernet3/0/9

    undo shutdown

    ip address 31.1.1.1 255.255.255.0

    ospf timer hello 3

    ospf timer dead 4   

   #

   return

   
   ```

**风险的恢复方案**

请按照配置规范进行配置。

#### 1.7.1.2 IGP引入路由优先级需要高于IGP的路由避免流量绕行

网络中同时存在多台ASBR设备的IGP引入外部路由时，如果外部路由的优先级低于IGP，则会只有一台设备IGP能够成功引入外部路由，其他ASBR上通过IGP学习到路由，导致流量绕行。

##### 应用场景

如[图1-8](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_004801)所示，RouterA和RouterB为出口设备，在RouterA和RouterB上OSPF都引入BGP路由重发布给RouterC和RouterD引导上行流量。由于BGP路由优先级低于OSPF，可能会出现RouterB学习到RouterA重发布的OSPF路由后，RouterB上的BGP路由变为不活跃状态，RouterB就不会重发布路由给RouterD。这样RouterD上行流量就会绕行RouterC，到达RouterA出口。

**图1-8** IGP引入路由优先级低于IGP的路由导致流量绕行组网图
![img](.images/download)

##### 配置规范

执行**preference**命令调整IGP协议的路由优选先级低于被引入的路由协议优先级（数值越小，优先级越高）。

![img](.images/download) **说明：**

修改优先级时需要注意避免影响正常业务。

##### 非规范配置的风险

**风险描述**

1. 网络中多台ASBR设备的IGP引入外部路由。
2. 被引入的外部路由优先级低于IGP的路由协议优先级。

当同时满足上述条件时，业务流量绕行。

业务现象如下：

业务流量没有按照原始路由协议的路径转发，而是通过IGP路由绕行到一台ASBR上，然后按照原始路由协议转发。

**风险的判断方法**

1. 执行如下命令，查看配置中IGP协议是否引入了外部路由。

   \# 在任意视图下执行**display current-configuration configuration ospf**命令，查看配置中OSPF协议是否引入了外部路由。显示信息说明OSPF协引入了BGP路由。

   ```
   <HUAWEI> display current-configuration configuration ospf
   #
   ospf 1 router-id 1.1.1.6
    import-route bgp  
    area 0.0.0.0
     network 1.1.19.6 0.0.0.0
   #
   return
   ```

   \# 在任意视图下执行**display current-configuration configuration ospfv3**命令，查看配置中OSPFv3协议是否引入了外部路由。显示信息说明OSPFv3协引入了静态路由。

   ```
   <HUAWEI> display current-configuration configuration ospfv3 
   #
   ospfv3 1
    router-id 1.1.1.1
    import-route static 
   #
   return
   ```

   \# 在任意视图下执行**display current-configuration configuration isis**命令，查看配置中ISIS协议是否引入了外部路由。显示信息说明ISIS协引入了静态路由。

   ```
   <HUAWEI> display current-configuration configuration isis
   #
   isis 1
    cost-style wide
    network-entity 10.000a.0011.0006.00
    import-route static  
   #
   return
   ```

2. 通过配置查看被引入到IGP协议的路由优先级。

   \# 查看OSPF协议配置。OSPF区域内和区域间路由的优先级为200，OSPF ASE和NSSA路由优先级为200。

   ```
   <HUAWEI> system-view
   [HUAWEI] ospf 1
   [HUAWEI-ospf-1] display this
   #
   ospf 1
    preference 200      
    preference ase 200  
   #
   return
   ```

   \# 查看OSPFv3协议配置。OSPFv3区域内和区域间路由的优先级为100，OSPFv3 ASE和NSSA路由优先级为100。

   ```
   <HUAWEI> system-view
   [HUAWEI] ospfv3 1
   [HUAWEI-ospfv3-1] display this
   #
   ospfv3 1
    router-id 1.1.19.6
    preference 100        
    preference ase 100    
   #
   return
   ```

   \# 查看ISIS协议配置。ISIS区域内和区域间路由的优先级为200。

   ```
   <HUAWEI> system-view

   [HUAWEI] isis 1

   [HUAWEI-isis-1]  display this

   #

   isis 1

    cost-style wide

    network-entity 00.0005.0000.0019.0006.00

    preference 200    

   #

   return
   ```

   \# 查看BGP协议配置。EBGP路由的优先级为200，IBGP协议的优先级为180，BGP Local的优先级为150。

   ```
   <HUAWEI> system-view

   [HUAWEI] bgp

   [HUAWEI-bgp] display this 

   #

   bgp 100

    #

    ipv4-family unicast

     undo synchronization

     preference 200 180 150   

   #
   ```

   \# 查看RIP协议配置。RIP路由的优先级为200。

   ```
   <HUAWEI> display current-configuration configuration rip

   #

   rip 1

    preference 200  

   #

   return
   ```

   \# 查看RIPng协议配置。RIPng路由的优先级为200。

   ```
   <HUAWEI> display current-configuration configuration ripng

   #

   ripng 1

    preference 200  

   #

   return
   ```

   \# 查看静态路由配置。静态路由的优先级为200。

   ```
   <HUAWEI> display current-configuration configuration

   #

    …… 

   ip route-static 1.1.1.1 32 NULL 0 preference 200  

   #
   ```

3. 如果没有配置路由优先级，华为设备各协议缺省优先级如下：

   | Route soure | Huawei Prefrence |
   | ----------- | ---------------- |
   | DIRECT      | 0                |
   | OSPF        | 10               |
   | IS-IS       | 15               |
   | STATIC      | 60               |
   | RIP         | 100              |
   | OSPF ASE    | 150              |
   | OSPF NSSA   | 150              |
   | IBGP        | 255              |
   | EBGP        | 255              |
   | BGP Local   | 255              |

   如果IGP的路由协议优先级高于引入的外部路由优先级，则存在流量绕行的风险。

**风险的恢复方案**

请按照配置规范进行配置。

### 1.7.2 OSPF的配置规范

#### 1.7.2.1 OSPF两端接口网络类型需要配置一致才能实现邻居建立后正常学习路由

OSPF两端接口网络类型不一致，一端为点对点，一端为广播网，导致邻居建立后无法学习路由。

##### 应用场景

设备使能了OSPF协议。

##### 配置规范

在接口视图下，执行命令**ospf network-type**命令，将两端设备接口下的OSPF网络类型修改为一致。

##### 非规范配置的风险

**风险描述**

当OSPF两端接口网络类型不一致，一端为点对点，一端为广播网时，虽然OSPF邻居可以正常建立，但是无法正确计算路由，进而导致依赖这些路由的业务不通。

业务现象如下：

OSPF邻居可以正常建立，但是无法学习路由。

**风险的判断方法**

1. 在用户视图下执行**display ospf interface all**命令，查看所有接口的OSPF详细信息。

   从显示信息可以看出，OSPF在GigabitEthernet1/0/1和GigabitEthernet1/1/0接口建立广播网邻居。

   ```
   <HUAWEI> display ospf interface all

            OSPF Process 101 with Router ID 1.1.1.1
                    Interfaces 
   
    Area: 0.0.0.0          (MPLS TE not enabled)
   
    Interface: 192.168.1.1 (GigabitEthernet1/0/1)
    Cost: 1       State: DROther    Type: Broadcast    MTU: 1500  Priority: 123
    Designated Router: 192.168.1.3
    Backup Designated Router: 0.0.0.0
    Timers: Hello 10 , Dead 40 , Poll  120 , Retransmit 5 , Transmit Delay 1 
   
    Interface: 192.168.2.1 (GigabitEthernet1/1/0)
    Cost: 1       State: DROther    Type: Broadcast    MTU: 1500  
    Priority: 0
    Designated Router: 192.168.2.3              
    Backup Designated Router: 0.0.0.0
    Timers: Hello 10 , Dead 40 , Poll  120 , Retransmit 5 , Transmit Delay 1
   ```

2. 在用户视图下，执行**display ospf peer** *interface-name*命令，查看接口所建立的OSPF邻居。

   如果没有邻居或者邻居状态不为Full，则检查下一个接口；否则需要根据接口类型判断两端接口类型是否一致。

   ![img](.images/download) **说明：**

   - 广播网接口的邻居的DR字段必须有IP地址，若该字段显示为DR: None，则认为两端接口类型不一致。
   - 点对点接口的邻居的DR字段必须显示为DR: None，如果显示为其它，则认为两端接口类型不一致。

   从显示信息可以看出，广播网接口GigabitEthernet1/0/1的Full邻居的DR字段没有IP地址，可以判断为两端接口类型不一致。

   ```
   <HUAWEI> display ospf peer GigabitEthernet1/0/1
           OSPF Process 101 with Router ID 1.1.1.1
                    Neighbors 
   
    Area 0.0.0.0 interface 192.168.1.1(GigabitEthernet1/0/1)'s neighbors
    Router ID: 1.1.1.3    Address: 192.168.1.3      
      State: Full  Mode:Nbr is  Master  Priority: 123
      DR: None   BDR: None   MTU: 0    
      Dead timer due in 33  sec 
      Retrans timer interval: 5 
      Neighbor is up for 00:45:35     
      Authentication Sequence: [ 0 ]
   <HUAWEI> display ospf peer GigabitEthernet1/1/0
   
            OSPF Process 101 with Router ID 1.1.1.1
                    Neighbors 
   
    Area 0.0.0.0 interface 192.168.2.1(GigabitEthernet1/1/0)'s neighbors
    Router ID: 1.1.1.3    Address: 192.168.2.3        
      State: Full  Mode:Nbr is  Master  Priority: 1
   DR: 192.168.2.3  BDR: None   MTU: 0        Dead timer due in 32  sec 
      Retrans timer interval: 5 
      Neighbor is up for 00:23:12     
      Authentication Sequence: [ 0 ]
   ```

**风险的恢复方案**

将两端设备接口下的OSPF网络类型修改为一致。

在接口视图下，执行命令**ospf network-type**命令，将两端设备接口下的OSPF网络类型修改为一致。

1. 由显示信息可以看出，GigabitEthernet1/0/1接口网络类型已经被修改为点对点。

   ```
   <HUAWEI> system-view
   [HUAWEI] interface GigabitEthernet1/0/1
   [HUAWEI-GigabitEthernet1/0/1] display this
   #
   interface GigabitEthernet1/0/1
    undo shutdown
    ip address 192.168.1.1 255.255.255.0
    ospf network-type p2p 
    ospf dr-priority 123
   #
   return
   ```

2. 在两端设备的用户视图下执行**display ospf peer** *interface-name*命令，查看OSPF邻居的DR字段。

   由显示信息可以看出，GigabitEthernet1/0/1的DR字段已经显示为IP地址，配置正确。

   ```
   <HUAWEI> display ospf peer GigabitEthernet1/0/1
            OSPF Process 101 with Router ID 1.1.1.1
                    Neighbors 
   
    Area 0.0.0.0 interface 192.168.1.1(GigabitEthernet1/0/1)'s neighbors
    Router ID: 1.1.1.3    Address: 192.168.1.3      
      State: Full  Mode:Nbr is  Master  Priority: 123
      DR: 192.168.1.1  BDR: 192.168.1.3  MTU: 0    
      Dead timer due in 38  sec 
      Retrans timer interval: 5 
      Neighbor is up for 00:00:07     
      Authentication Sequence: [ 0 ]
   ```

### 1.7.3 ISIS的配置规范

#### 1.7.3.1 割接过程中需要删除发布的缺省路由

IS-IS可以通过LSP中设置过载标志位，使得经过该设备的路由切换到备份路径。但是设置过载标志位并不会影响发布缺省路由，缺省路由不会切换路径。

##### 应用场景

如[图1-9](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_003001)所示，RouterA、RouterB、RouterC、RouterD之间建立IS-IS邻居。链路T为业务主路径，RouterA->RouterB->RouterD为备份路径。

- 割接过程中，RouterC的IS-IS视图下配置**set-overload**命令，将业务切换到备份路径场景。
- RouterC的IS-IS视图下配置**set-overload** **on-startup**命令，设备主备倒换或者重启后，路由延时回切场景。

**图1-9** IS-IS协议设置过载标志位不会取消发布缺省路由组网图
![img](.images/download)

##### 配置规范

割接过程中，IS-IS视图下，删除发布缺省路由命令，割接完成后需要再重新配置。

```
<HUAWEI> system-view 
[HUAWEI] isis 1
[HUAWEI-isis-1] undo default-route-advertise
```

##### 非规范配置的风险

**风险描述**

当RouterC的IS-IS视图下配置了**set-overload** [ **on-startup** ]命令设置非伪节点LSP的过载标志位，并且配置了**default-route-advertise**命令，发布缺省路由时，缺省路由不会切换到备份路径。此时如果设备上没有明细路由，则会导致业务中断。

业务现象如下：

设备重启后600秒内，缺省路由没有切换到备份路径。

**风险的判断方法**

在任意视图下执行**display isis** *process-id* **lsdb local verbose**命令查看LSP信息，如果**OL**位为**1**，说明已经设置了过载标志位。同时如果发布了缺省路由，说明问题发生。加粗字体表示设置了**overload**同时发布了缺省路由。

```
<HUAWEI> display isis 1 lsdb local verbose

        ATTENTION: System is overloaded 
        Manual overload set     YES     OverLoad on Startup     NO
        System Memory Low       NO      Memory Allocate Failure NO


                          Level-2 Link State Database

LSPID              Seq Num     Checksum     Holdtime      Length  ATT/P/OL
-------------------------------------------------------------------------------

abcd.0001.0031.00-00* 0x0000008e   0x6726        1183          76      0/0/1  
 SOURCE       abcd.0001.0031.00
 NLPID        IPV4
 AREA ADDR    10 
 INTF ADDR    10.10.1.1
 INTF ADDR    30.1.1.2
+NBR  ID      aaaa.0001.0030.00  COST: 10        
+IP-Extended  10.10.1.1      255.255.255.255  COST: 0         
+IP-Extended  30.1.1.0       255.255.255.0    COST: 10        

abcd.0001.0031.00-01* 0x00000001   0x289a        1179          34      0/0/0  
 SOURCE       abcd.0001.0031.00
+IP-Extended  0.0.0.0        0.0.0.0          COST: 0         

    *(In TLV)-Leaking Route, *(By LSPID)-Self LSP, +-Self LSP(Extended), 
           ATT-Attached, P-Partition, OL-Overload
```

**风险的恢复方案**

请按照配置规范进行配置。

#### 1.7.3.2 IS-IS配置IPv6标准拓扑模式下使用IPv6拓扑

IS-IS IPv6标准拓扑模式，IPv6与IPv4共享最短路径树，如果最短路径树上存在出接口只支持IPv4协议的设备，则会在该设备上形成IPv6黑洞路由或者路由环路，导致IPv6业务受损。

##### 应用场景

如[图1-10](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_003101)所示，RouterA、RouterB、RouterC、RouterD之间建立IS-IS邻居。IS-IS部署IPv4和IPv6业务，使用IPv6标准拓扑。

**图1-10** IPv6标准拓扑模式下IPv6路由到IPv4单栈接口转发不通组网图
![img](.images/download)

##### 配置规范

网络中部署IPv6时，建议使用IS-IS IPv6拓扑，与IS-IS IPv4分开进行最短路径树计算。

```
<HUAWEI> system-view
[HUAWEI] isis 1
[HUAWEI-isis-1] display this    
#  
isis 1       
 cost-style wide 
 network-entity 10.0000.0000.0001.00  
 # 
 ipv6 enable topology ipv6 
 #  
# 
return  
```

##### 非规范配置的风险

**风险描述**

当在IS-IS进程视图下，执行**ipv6 enable topology standard**命令使能IS-IS进程的IPv6能力，并指定拓扑类型为标准模式，如果IS-IS最短路径上存在只支持IPv4协议的接口，IPv6业务流量到达只支持IPv4协议的设备后形成黑洞路由，导致业务不通。

业务现象如下：

IPv6业务流量不通。

**风险的判断方法**

1. 在任意视图下，执行**display current-configuration configuration isis**命令，查看IS-IS进程视图下是否配置了IPv6标准拓扑模式。

   ```
   <HUAWEI> display current-configuration configuration isis

   #       

   isis 1  

    cost-style wide              

    network-entity 10.0000.0000.0001.00       

    #     

    ipv6 enable topology standard            

    #      

   #       

   return   
   ```

2. 在任意视图下，执行**display isis** *process-id* **interface verbose**命令，查看IS-IS接口状态以及拓扑模式，找到**IPV4.State**为**UP**、**IPV6.State**为**Down**，并且**Circuit MT State**为**Standard**的接口。如下显示信息中为GE1/0/0.1接口。

   ```
   <HUAWEI> display isis 1001 interface verbose

   

                         Interface information for ISIS(1001)

                         ------------------------------------

    Interface       Id      IPV4.State          IPV6.State      MTU  Type  DIS   

    GE1/0/0.1   001         Up                 Down         1497 L1/L2 -- 

     Circuit MT State            : Standard

     Circuit Parameters          : p2p 

     Description                 : HUAWEI, GigabitEthernet1/0/0.1 Interface

     SNPA Address                : 781d-ba56-fa3a

     IP Address                  : 20.1.1.6

     IPV6 Link Local Address     :

     IPV6 Global Address(es)     :

     Csnp Timer Value            :  L12   10

     Hello Timer Value           :        10

     DIS Hello Timer Value       :

     ……
   ```

3. 在任意视图下，执行**display current-configuration configuration** **interface** *interface-name*命令，查看业务路径的出接口是否配置IPv6协议。下面显示中，GE1/0/0.1接口下没有配置**isis ipv6 enable**，说明存在问题。

   ```
   <HUAWEI> display current-configuration interface GigabitEthernet1/0/0.1 

   # 

   interface GigabitEthernet1/0/0.1         

    ip address 1.2.0.1 255.255.255.0  

    isis enable 1         

    isis circuit-type p2p  

   # 
   ```

**风险的恢复方案**

在该接口下配置IPv6。

```
<HUAWEI> system-view
[HUAWEI] interface GigabitEthernet1/0/0.1
[HUAWEI-interface-GigabitEthernet1/0/0.1] display this
#
interface GigabitEthernet1/0/0.1    
 ipv6 enable 
 ip address 1.2.0.1 255.255.255.0   
 ipv6 address auto link-local     
 isis enable 1           
 isis ipv6 enable 1 
 isis circuit-type p2p
#
```

### 1.7.4 BGP的配置规范

#### 1.7.4.1 BGP路由优先级配置规范

在设备上的静态路由通过OSPF协议发给对端设备后，对端又经过BGP协议发回给自己，如果在BGP视图配置了**preference**命令导致BGP路由协议优先级高于静态路由，就会引起BGP路由震荡。

##### 应用场景

如[图1-11](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_003301)所示组网中：

1. RouterA将某一条静态路由引入到OSPF路由表后，通过OSPF协议发送给RouterB。
2. RouterB再将OSPF协议引入到BGP路由表中，然后通过BGP协议将该路由发回给RouterA。
3. 此时如果RouterA的BGP视图下配置**preference**命令修改了路由协议的优先级，使得BGP路由协议的优先级比静态路由更高，就会导致静态路由不活跃。那么OSPF就会撤销这条路由，同时向RouterB发布撤销。
4. RouterB的BGP路由也会撤销，同时向RouterA发布撤销。RouterA的BGP路由一旦撤销，那么静态路由重新活跃，OSPF重新引入该静态路由，回到步骤1。这个过程会一直重复，导致路由震荡。

**图1-11** 修改BGP路由优先级导致BGP路由震荡组网图
![img](.images/download)

##### 配置规范

BGP路由协议优先级低于静态路由优先级。

##### 非规范配置的风险

**风险描述**

RouterA和RouterB之间配置了OSPF和BGP邻居，RouterA配置一条静态路由，并引入到OSPF路由表，RouterB通过**import-route**或**network**命令将路由引入到BGP路由表中，如果RouterA上BGP视图配置了**preference**命令修改了BGP路由协议的优先级，使得BGP路由协议的优先级比静态路由更高，则会出现路由震荡，使业务受到影响。

##### 风险的判断方法

1. RouterA上连续多次查看IP路由表路由，发现IP路由表静态和IBGP路由震荡交替。下面以IP地址为20.0.0.0为例。

   ```
   <HUAWEI> display ip routing-table 20.0.0.0 verbose

   Route Flags: R - relay, D - download to fib

   ------------------------------------------------------------------------------

   Routing Table : Public

   Summary Count : 1

   

   Destination: 20.0.0.0/8

        Protocol: Static           Process ID: 0

      Preference: 60                     Cost: 0

         NextHop: 0.0.0.0           Neighbour: 0.0.0.0

           State: Active Adv              Age: 04h36m27s

             Tag: 0                  Priority: medium

           Label: NULL                QoSInfo: 0x0

      IndirectID: 0x0              

    RelayNextHop: 0.0.0.0           Interface: NULL0

        TunnelID: 0x0                   Flags:  D

   

   <HUAWEI> display ip routing-table 20.0.0.0 verbose

   Route Flags: R - relay, D - download to fib

   ------------------------------------------------------------------------------

   Routing Table : Public

   Summary Count : 2

   

   Destination: 20.0.0.0/8

        Protocol: IBGP             Process ID: 0

      Preference: 20                     Cost: 1

         NextHop: 30.1.0.4        Neighbour: 30.1.0.4

           State: Active Adv Relied       Age: 00h00m00s

             Tag: 0                  Priority: low

           Label: NULL                QoSInfo: 0x0

      IndirectID: 0x1ee            

    RelayNextHop: 0.0.0.0           Interface: Vlanif503

        TunnelID: 0x0                   Flags: RD

   

   Destination: 20.0.0.0/8

        Protocol: Static           Process ID: 0

      Preference: 60                     Cost: 0

         NextHop: 0.0.0.0           Neighbour: 0.0.0.0

           State: Inactive Adv            Age: 04h36m28s

             Tag: 0                  Priority: medium

           Label: NULL                QoSInfo: 0x0

      IndirectID: 0x0              

    RelayNextHop: 0.0.0.0           Interface: NULL0

        TunnelID: 0x0                   Flags: 

   
   ```

2. RouterB也进行连续多次查看IP路由表的路由，发现路由也在震荡。

   ```
   <HUAWEI> display ip routing-table 20.0.0.0 verbose

   Route Flags: R - relay, D - download to fib

   ------------------------------------------------------------------------------

   Routing Table : Public

   Summary Count : 1

   

   Destination: 20.0.0.0/8

        Protocol: O_ASE            Process ID: 20

      Preference: 150                    Cost: 1

         NextHop: 30.1.0.3        Neighbour: 0.0.0.0

           State: Active Adv              Age: 00h00m14s

             Tag: 1                  Priority: medium

           Label: NULL                QoSInfo: 0x0

      IndirectID: 0x0              

    RelayNextHop: 0.0.0.0           Interface: Vlanif503

        TunnelID: 0x0                   Flags:  D

   <HUAWEI> display ip routing-table 20.0.0.0 verbose

   Route Flags: R - relay, D - download to fib

   ------------------------------------------------------------------------------

   Routing Table : Public

   Summary Count : 1

   

   Destination: 20.0.0.0/8

        Protocol: O_ASE            Process ID: 20

      Preference: 150                    Cost: 1

         NextHop: 30.1.0.3        Neighbour: 0.0.0.0

           State: Active Adv              Age: 00h00m00s

             Tag: 1                  Priority: medium

           Label: NULL                QoSInfo: 0x0

      IndirectID: 0x0              

    RelayNextHop: 0.0.0.0           Interface: Vlanif503

        TunnelID: 0x0                   Flags:  D

   <HUAWEI> display ip routing-table 20.0.0.0 verbose

   Route Flags: R - relay, D - download to fib

   ------------------------------------------------------------------------------

   Routing Table : Public

   Summary Count : 1

   

   Destination: 20.0.0.0/8

        Protocol: O_ASE            Process ID: 20

      Preference: 150                    Cost: 1
         NextHop: 30.1.0.3        Neighbour: 0.0.0.0

           State: Active Adv              Age: 00h00m01s

             Tag: 1                  Priority: medium

           Label: NULL                QoSInfo: 0x0

      IndirectID: 0x0              

    RelayNextHop: 0.0.0.0           Interface: Vlanif503

        TunnelID: 0x0                   Flags:  D
   ```

##### 风险的恢复方案

方案一：删除RouterA上BGP公网IPv4地址族的**preference**命令。

方案二：增大静态路由的优先级，使其高于BGP的优先级。
