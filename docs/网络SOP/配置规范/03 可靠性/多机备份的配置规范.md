# 可靠性

## 1. 多机备份的配置规范

### 1.1. 双机热备场景下部署共享地址池时需要配置保护隧道

双机热备场景下部署共享地址池时需要配置保护隧道，如果不配置，可能导致当主设备的用户侧链路故障时，下行流量无法入保护隧道到达用户，流量流失。

#### 1.1.1. 应用场景

双机热备场景下部署共享地址池，组网如下图所示。
![img](../.images/download)

#### 1.1.2. 配置规范

详情请参考：配置共享地址池方式下的用户信息备份。

#### 1.1.3. 非规范配置的风险

**风险描述**

按照现在双机热备份的部署，对于共享地址池的部署方式，当主设备的用户侧链路发生故障时，到达主设备的下行流量通过入保护隧道形式到达备用设备最后到达用户，如果未设置保护隧道，则下行流量无法顺利到达用户，导致下行流量丢失故障。

![img](../.images/download)

**风险的判断方法**

- 通过

  display remote-backup-service

  service-name

  命令，查看所有的RBS信息。

  - 判断RBS是否绑定了共享地址池：

    查看回显中的“ip pool”字段下是否有地址池名称。

    如有，说明RBS下绑定了共享地址池，继续判断。

    如果没有，说明此双机热备场景不是共享地址池，不涉及本配置规范。

  - 判断RBS是否配置了保护隧道：

    查看回显中是否有保护隧道类型，查看是否有出接口，回显中的“Protect-type”和“Out-interface”字段。

**风险的恢复方案**

同配置规范。

### 1.2. 双机热备场景下部署共享地址池时网络侧接口需要去使能URPF

#### 1.2.1. 应用场景

双机热备场景下部署共享地址池，组网如下图所示。

![img](../.images/download)

#### 1.2.2. 配置规范

网络侧接口需要去使能URPF，即配置**undo ip urpf**。

#### 1.2.3. 非规范配置的风险

**风险描述**

在双机热备设备上配置共享地址池时，当主设备的用户侧链路发生故障时，流量会经过保护隧道迂回到用户，如果网络侧接口下配置URPF，会概率导致下行流量无法入保护隧道到达用户，流量流失。

![img](../.images/download)

**风险的判断方法**

- 通过

  display remote-backup-service

  service-name

  命令，查看所有的RBS信息。

  - 判断RBS是否绑定了共享地址池：

    查看回显中的“ip pool”字段下是否有地址池名称。

    如有，说明RBS下绑定了共享地址池，继续判断。

    如果没有，说明此双机热备场景不是共享地址池，不涉及本配置规范。

  - 判断RBS是否配置了保护隧道：

    查看回显中是否有保护隧道类型，查看是否有出接口，回显中的“Protect-type”和“Out-interface”字段。

  ```
  [HUAWEI] display remote-backup-service rbs                                                                                                  
  ----------------------------------------------------------                                                                          
   Service-Index    : 2                                                                                                               
   Service-Name     : rbs                                                                                                             
   TCP-State        : Initial                                                                                                         
   Peer-ip          : 28.1.1.1                                                                                                        
   Source-ip        : 6.6.6.3                                                                                                         
   TCP-Port         : 6002                                                                                                            
   Track-BFD        : --                                                                                                              
   Uplink state     : 2 (1:DOWN 2:UP)                                                                                                 
   Domain-map-list  : --                                                                                                              
  ----------------------------------------------------------                                                                          
                                                                                                                                      
   ip pool:                                                                                                                           
           zw metric 20                                                                                                               
   ipv6 pool:                                                                                                                         
   Failure ratio    : 100%                                                                                                            
   Failure duration : 0 min                                                                                                           
  ----------------------------------------------------------                                                                          
   Rbs-ID         : 2                                                                                                                 
   Protect-type   : ip-redirect                                                                                                       
   Next-hop       : 115.1.1.2                                                                                                         
   Vlanid         : 0                                                                                                                 
   Peer-ip        : 115.1.1.2                                                                                                         
   Vrfid          : 0                                                                                                                 
   Tunnel-state   : UP                                                                                                                
   Tunnel-OperFlag: NORMAL                                                                                                            
   Spec-interface : GigabitEthernet1/0/2                                                                                              
   Total users    : 0                                                                                                                 
   Path 1:                                                                                                                            
       Tunnel-index   : 0x0                                                                                                           
       Tunnel-index-v6: 0x0                                                                                                           
       Out-interface  : GigabitEthernet1/0/2                                                                                          
       Vc-lable       : 4294967295                                                                                                    
       Vc-lable-v6    : 4294967295                                                                                                    
       User-number    : 0                                                                                                             
       Public-Lsp-Load: FALSE                                                                                                         
                                                                                                                                      
  ----------------------------------------------------------                                                                          
   Rbs-ID         : 2                                                                                                                 
   Protect-type   : public(LSP)                                                                                                       
   Peer-ip        : 17.17.17.17                                                                                                       
   Vrfid          : 4091                                                                                                              
   Tunnel-state   : UP                                                                                                                
   Tunnel-OperFlag: NORMAL                                                                                                            
   Spec-interface : Null                                                                                                              
   Total users    : 0                                                                                                                 
   Path 1:                                                                                                                            
       Tunnel-index   : 0x400000f                                                                                                     
       Tunnel-index-v6: 0x0                                                                                                           
       Out-interface  : GigabitEthernet2/0/1                                                                                          
       Vc-lable       : 4294967295                                                                                                    
       Vc-lable-v6    : 4294967295                                                                                                    
       User-number    : 0                                                                                                             
       Public-Lsp-Load: TRUE   
  ```

- 在网络侧接口视图下，执行 display this ，查看是否配置了URPF。

  ```
  [HUAWEI -GigabitEthernet2/0/1] display this                                                                                                      
  #                                                                                                                                   
  interface GigabitEthernet2/0/1                                                                                                      
   description ith                                                                                                                    
   undo shutdown                                                                                                                      
   ipv6 enable                                                                                                                        
   ip address 186.0.0.17 255.255.255.0                                                                                                
   ipv6 address 13:16::2/64                                                                                                           
   mpls                                                                                                                               
   mpls ldp                                                                                                                           
   undo dcn
   ip urpf strict   
  ipv6 urpf strict                                                                                                                       
  #        
  ```

**风险的恢复方案**

同配置规范。