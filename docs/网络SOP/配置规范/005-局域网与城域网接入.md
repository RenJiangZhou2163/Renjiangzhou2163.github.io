
## 1.5 局域网与城域网接入

### 1.5.1 MAC的配置规范

#### 1.5.1.1 二层设备上行流量少的场景下MAC老化时间需要配置大于或接近ARP老化时间

二层设备上行流量少的场景下MAC老化时间需要配置大于或接近ARP老化时间

##### 应用场景

![img](.images/download) **说明：**

此场景仅LPUF-50/LPUI-21-L/LPUF-50-L/LPUF-51/LPUI-51/LPUS-51/LPUF-101/LPUI-101/LPUS-101/LPUI-51-E/LPUF-51-E/LPUF-102/LPUF-102-E/LPUI-102-E/LPUF-120/LPUF-120-E/LPUI-120/LPUS-120/LPUF-240/LPUF-240-E/LPUI-240/LPUI-52-E/LPUI-120-E/LPUF-200-E单板涉及。

如下图所示，Device下有3个二层设备Device A、Device B、Device C，由GE1/0/0、GE2/0/0、GE3/0/0分别连接，GE1/0/0、GE2/0/0、GE3/0/0加入VLANIF10。GE1/0/0学到Device A的ARP和MAC地址。如果目的IP为10.0.0.1的下行流量到Device，Device将首先根据目的IP查路由表，然后根据得到的下一跳IP地址查ARP表项，得到VLAN和MAC地址，最后根据VLAN+MAC表查MAC表，根据MAC表的出接口，将流量转发到GE1/0/0给Device A。

在这种场景下，Device上的ARP表项、MAC地址的更新方式有2种：

- 第一种是根据系统设置的老化时间，每隔一段时间自动检测
- 第二种是根据二层设备的上行流量读取更新

如果Device A往Device的上行流量很少，那Device上的ARP表项、MAC地址的更新就只能通过ARP每隔一段时间自动检测。

![img](.images/download)

##### 配置规范

1. 查询当前的ARP老化时间。进入对应的接口视图，执行命令**display this**，查看是否有“arp expire-time”的配置，如果没有，ARP老化时间是默认值1200秒（20分钟），如果有配置，以配置的值为准。
2. 设置MAC老化时间。进入系统视图，执行命令**mac-address aging-time** *seconds*，设置*seconds*大于等于上面查询到的ARP老化时间。*seconds*的默认值为300秒（5分钟）。

##### 非规范配置的风险

**风险描述**

由于Device A往Device的上行流量很少，那Device上的ARP表项、MAC地址的更新就只能通过ARP每隔一段时间自动检测。这时，如果Device的MAC老化时间比ARP老化时间短，Device A的MAC地址会被老化掉，但是ARP地址还在。此时Device收到发往Device A的流量时，转发时会查不到MAC表，从而在VLAN 10内广播，Device B和Device C设备都会收到 发往Device A的流量，导致Device B、Device C设备的正常业务受到影响。

![img](.images/download)

**风险的判断方法**

1. 查询当前的ARP老化时间。进入对应的接口视图，执行命令**display this**，查看是否有“arp expire-time”的配置，如果没有，ARP老化时间是默认值1200秒（20分钟），如果有配置，以配置的值为准。

   例如，下述举例中，没有“arp expire-time”的配置，所以ARP老化时间是默认值1200秒（20分钟）。

   ```
   [HUAWEI-GigabitEthernet1/0/0] display this
   #
   interface GigabitEthernet1/0/0
    portswitch 
    undo shutdown 
    port link-type access 
    port default vlan 10
   #
   return
   ```

2. 查询MAC老化时间，如果MAC老化时间低于上述查询到的ARP老化时间，则存在风险。进入系统视图，执行命令**display mac-address aging-time**，查看字段“Aging time”的显示数值。例如，下述回显显示，系统的MAC老化时间为300秒。

   ```
   <HUAWEI> display mac-address aging-time
     Aging time: 300 second(s)
   ```

**风险的恢复方案**

同配置规范。

### 1.5.2 Eth-Trunk的配置规范

#### 1.5.2.1 部署E-Trunk的两台设备全局配置需完全一致

对于Eth-Trunk配置静态LACP、Eth-Trunk加入E-Trunk场景，要求部署E-Trunk的两台设备全局配置**lacp e-trunk system-id** *system-id*和**lacp e-trunk priority** *priority*命令并且配置完全一致，否则存在E-Trunk成员口Eth-Trunk状态和预期不一致的风险。

##### 应用场景

如[图1-6](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_002101)所示，Eth-Trunk配置静态LACP模式，并且加入E-Trunk。

**图1-6** LACP E-Trunk全局配置不对称导致Eth-Trunk状态错误组网图
![img](.images/download)

静态LACP模式的Eth-Trunk接口场景请参见NE40E&NE80E支持的Eth-Trunk接口特性。

##### 配置规范

配置静态LACP模式的Eth-Trunk接口，并且将Eth-Trunk接口加入E-Trunk后，部署E-Trunk的PE1和PE2设备系统视图下均配置**lacp e-trunk system-id** *system-id*和**lacp e-trunk priority** *priority*命令，且两台设备的*system-id*和*priority*参数取值一致。

##### 非规范配置的风险

**风险描述**

部署E-Trunk的PE1和PE2设备的**System ID**和**System Priority**信息不一致，会导致E-Trunk成员口Eth-Trunk状态和预期主备不一致的风险。

**风险的判断方法**

Eth-Trunk的两端设备上，任意视图下执行**display eth-trunk** *eth-trunk-id*命令查看**System ID**和**System Priority**回显信息。

如下回显信息说明PE1和PE2设备上，系统ID **System ID**一致，但是系统优先级**System Priority**不一致。

\# 查看PE1设备，发现Eth-Trunk1加入了E-Trunk1。

```
<HUAWEI> system-view
[HUAWEI] interface eth-trunk 1
[HUAWEI-Eth-Trunk1] display this
#
interface Eth-Trunk1
 mode lacp-static
 e-trunk 1  
#
[HUAWEI] display eth-trunk 1
Eth-Trunk1's state information is:
Local:
LAG ID: 1                   WorkingMode: STATIC                               
Preempt Delay: Disabled     Hash arithmetic: According to flow                
System Priority: 100        System ID: 0001-0001-0001                         
Least Active-linknumber: 1  Max Active-linknumber: 16                         
Operate status: down        Number Of Up Port In Trunk: 0                     
--------------------------------------------------------------------------------
ActorPortName          Status   PortType PortPri PortNo PortKey PortState Weight

Partner:
--------------------------------------------------------------------------------
ActorPortName          SysPri   SystemID        PortPri PortNo PortKey PortState
```

\# 查看PE2设备，发现Eth-Trunk1加入了E-Trunk1。

```
<HUAWEI> system-view
[HUAWEI] interface eth-trunk 1
[HUAWEI-Eth-Trunk1] display this 
#
interface Eth-Trunk1
 mode lacp-static
 e-trunk 1  
#
[HUAWEI] display eth-trunk 1
Eth-Trunk1's state information is:
Local:
LAG ID: 1                   WorkingMode: STATIC                               
Preempt Delay: Disabled     Hash arithmetic: According to flow                
System Priority: 101        System ID: 0001-0001-0001                         
Least Active-linknumber: 1  Max Active-linknumber: 16                         
Operate status: up        Number Of Up Port In Trunk: 0                     
--------------------------------------------------------------------------------
ActorPortName          Status   PortType PortPri PortNo PortKey PortState Weight

Partner:
--------------------------------------------------------------------------------
ActorPortName          SysPri   SystemID        PortPri PortNo PortKey PortState
```

**风险的恢复方案**

问题发生后，PE1和PE2设备分别执行**lacp e-trunk system-id** *system-id*和**lacp e-trunk priority** *priority*命令，修改两台设备的*system-id*和*priority*参数取值修改为一致。

#### 1.5.2.2 Eth-Trunk需配置LACP模式或成员接口绑定BFD会话

在Eth-Trunk接口下存在成员接口没有绑定BFD会话，且该Eth-Trunk接口的工作模式不是静态LACP模式，链路出现故障无法及时发现。

##### 应用场景

设备配置Eth-Trunk接口。

##### 配置规范

配置Eth-Trunk接口为静态LACP模式，或者配置Eth-Trunk成员口绑定BFD会话。

- 当采用配置Eth-Trunk接口为静态LACP模式时，建议LACP超时时间设为默认值(3s)。
- 当采用配置Eth-Trunk成员口绑定BFD会话解决方案时，需要将所有的Eth-Trunk成员口都绑定BFD会话，同时建议配置BFD回切延时(WTR)。

##### 非规范配置的风险

**风险描述**

Eth-Trunk未配置为LACP模式且成员接口没有绑定BFD会话，Eth-Trunk成员口发生链路故障时不能及时发现，业务不能及时切换。如果Eth-Trunk成员接口绑定BFD会话时，建议使能BFD回切延时（WTR）功能，避免因BFD会话频繁震荡，导致Eth-Trunk成员接口频繁震荡，影响业务收敛。

**风险的判断方法**

1. 查看Eth-Trunk接口是否配置了静态LACP模式。

   如下回显表示Eth-Trunk1配置了静态LACP模式，而Eth-Trunk2、Eth-Trunk3未配置静态LACP模式，Eth-Trunk2、Eth-Trunk3可能存在本案例描述的问题，需要查看Eth-Trunk2、Eth-Trunk3的成员口是否绑定了BFD会话。

   ```
   <HUAWEI> display current-configuration interface Eth-Trunk
   ……
   #
   interface Eth-Trunk1
   mode lacp-static
   #
   interface Eth-Trunk2
   #
   interface Eth-Trunk3
   #
   ```

2. 查看Eth-Trunk成员口是否绑定BFD会话。

   如下回显表示Eth-Trunk2的成员口GigabitEthernet1/0/0绑定了BFD会话，而其成员口GigabitEthernet3/0/0未绑定了BFD会话；Eth-Trunk3的两个成员口虽然绑定了BFD会话，但未配置BFD回切延时。

   因此，Eth-Trunk2、Eth-Trunk3都存在本案例描述的问题。

   \# 查看Eth-Trunk的成员口。

   ```
   <HUAWEI> display eth-trunk 2
   Eth-Trunk2's state information is: 
   WorkingMode: NORMAL         Hash arithmetic: According to flow                 
   Least Active-linknumber: 1  Max Bandwidth-affected-linknumber: 16              
   Operate status: up          Number Of Up Port In Trunk: 2                      
   -------------------------------------------------------------------------------- 
   PortName                      Status      Weight  
   GigabitEthernet1/0/0             Up          1   
   GigabitEthernet3/0/0             Up          1   
   ```

   ```
   <HUAWEI> display eth-trunk 3
   Eth-Trunk3's state information is: 
   WorkingMode: NORMAL         Hash arithmetic: According to flow                 
   Least Active-linknumber: 1  Max Bandwidth-affected-linknumber: 16              
   Operate status: up          Number Of Up Port In Trunk: 2                      
   -------------------------------------------------------------------------------- 
   PortName                      Status      Weight  
   GigabitEthernet2/0/0             Up          1    
   GigabitEthernet4/0/0             Up          1   
   ```

   \# 查看Eth-Trunk所有成员口是否绑定BFD会话

   ```
   <HUAWEI> display current-configuration configuration bfd-session
   #
   bfd eth-trunk2-1 bind peer-ip default-ip interface GigabitEthernet1/0/0
    discriminator local 6013
    discriminator remote 6213
    wtr 10
    process-interface-status
    commit
   //成员口GigabitEthernet3/0/0未绑定BFD
   #
   bfd eth-trunk3-1 bind peer-ip default-ip interface GigabitEthernet2/0/0 
    discriminator local 6013 
    discriminator remote 6213 
    process-interface-status 
    commit 
   //BFD未配置回切延时
   #
   bfd eth-trunk3-2 bind peer-ip default-ip interface GigabitEthernet4/0/0 
    discriminator local 6013 
    discriminator remote 6213 
    process-interface-status 
    commit 
   //BFD未配置回切延时
   #
   ```

**风险的恢复方案**

配置Eth-Trunk 1、Eth-Trunk 2、Eth-Trunk 3接口为静态LACP模式，或者配置Eth-Trunk 2、Eth-Trunk 3成员口绑定BFD会话。

- 配置Eth-Trunk接口为LACP模式。

  \# 配置Eth-Trunk 1接口。

  ```
  <HUAWEI> system-view
  [HUAWEI] interface eth-trunk 1
  [HUAWEI-Eth-Trunk1] mode lacp-static
  [HUAWEI-Eth-Trunk1] quit
  ```

  \# 配置Eth-Trunk 2接口。

  ```
  [HUAWEI] interface eth-trunk 2
  [HUAWEI-Eth-Trunk2] mode lacp-static
  [HUAWEI-Eth-Trunk2] quit
  ```

  \# 配置Eth-Trunk 3接口。

  ```
  [HUAWEI] interface eth-trunk 3
  [HUAWEI-Eth-Trunk3] mode lacp-static
  ```

- 配置Eth-Trunk成员口绑定BFD会话。

  \# 配置Eth-Trunk 2接口。

  ```
  <HUAWEI> system-view
  [HUAWEI] bfd eth-trunk2-1 bind peer-ip default-ip interface GigabitEthernet1/0/0
  [HUAWEI-bfd-session-eth-trunk2-1] wtr 10
  [HUAWEI-bfd-session-eth-trunk2-1] process-interface-status
  [HUAWEI-bfd-session-eth-trunk2-1] quit
  [HUAWEI] bfd eth-trunk2-2 bind peer-ip default-ip interface GigabitEthernet3/0/0
  [HUAWEI-bfd-session-eth-trunk2-2] wtr 10 
  [HUAWEI-bfd-session-eth-trunk2-2] process-interface-status
  ```

  \# 配置Eth-Trunk 3接口。

  ```
  <HUAWEI> system-view
  [HUAWEI] bfd reth-trunk3-1 bind peer-ip default-ip interface GigabitEthernet2/0/0
  [HUAWEI-bfd-session-eth-trunk3-1] wtr 10
  [HUAWEI-bfd-session-eth-trunk3-1] process-interface-status
  [HUAWEI-bfd-session-eth-trunk3-1] quit
  [HUAWEI] bfd eth-trunk3-2 bind peer-ip default-ip interface GigabitEthernet4/0/0
  [HUAWEI-bfd-session-eth-trunk3-2] wtr 10 
  [HUAWEI-bfd-session-eth-trunk3-2] process-interface-status
  ```

#### 1.5.2.3 一端未加入Eth-Trunk导致流量不通

当链路一端设备的接口加入到Eth-Trunk中，另一端设备的接口未加入Eth-Trunk时，会导致流量不通。

##### 应用场景

两台路由器通过3个GE接口直连，将这3个GE接口捆绑，形成一个Eth-Trunk接口，从而实现了增加带宽和提高可靠性的目的。

**图1-7** Eth-Trunk使用场景图
![img](.images/download)

##### 配置规范

对接Eth-Trunk的两台设备，两台设备上的对接接口需要全部加入到Eth-Trunk中。

##### 非规范配置的风险

**风险描述**

如果出现链路一端接口加入到Eth-Trunk中，但是另一端没有加入，数据流量走到该链路上的话，可能会导致流量不通。

业务现象如下：

接口均加入到Eth-Trunk的设备在转发流量时会将报文分担到全部接口上，但是对端存在接口没有加入到Eth-Trunk，那么对端未加入到Eth-Trunk的接口无法接收、转发流量。

**风险的判断方法**

在两侧设备上查看是否对接的接口都加入到了Eth-Trunk中。

```
<Device1> display eth-trunk 10
Eth-Trunk10's state information is:                                                                                                 
WorkingMode: NORMAL         Hash arithmetic: According to flow                                                                      
Least Active-linknumber: 1  Max Bandwidth-affected-linknumber: 16                                                                   
Operate status: up          Number Of Up Port In Trunk: 3                                                                           
--------------------------------------------------------------------------------                                                    
PortName                      Status      Weight                                                                                    
GigabitEthernet1/0/0          Up          1                                                                                         
GigabitEthernet1/0/1          Up          1                                                                                         
GigabitEthernet2/0/0          Up          1
<Device2> display eth-trunk 10
Eth-Trunk10's state information is:                                                                                                 
WorkingMode: NORMAL         Hash arithmetic: According to flow                                                                      
Least Active-linknumber: 1  Max Bandwidth-affected-linknumber: 16                                                                   
Operate status: up          Number Of Up Port In Trunk: 1                                                                           
--------------------------------------------------------------------------------                                                    
PortName                      Status      Weight                                                                                    
GigabitEthernet1/0/0          Up          1 
```

**风险的恢复方案**

将对接接口加入到Eth-Trunk中。

```
<Device2> system-view
[Device2] interface GigabitEthernet1/0/1
[Device2-GigabitEthernet1/0/1] eth-trunk 10
[Device2-GigabitEthernet1/0/1] quit
[Device2] interface GigabitEthernet2/0/0
[Device2-GigabitEthernet2/0/0] eth-trunk 10
[Device2-GigabitEthernet2/0/0] quit
```

### 1.5.3 IP-Trunk的配置规范

#### 1.5.3.1 IP-Trunk需配置成员接口绑定BFD会话

在IP-Trunk接口下存在成员接口没有绑定BFD会话，链路出现故障无法及时发现。

##### 应用场景

设备配置IP-Trunk接口。

##### 配置规范

配置IP-Trunk成员口绑定BFD会话。

- 当采用配置IP-Trunk成员口绑定BFD会话解决方案时，需要将此IP-Trunk的所有成员口都绑定BFD会话。

  ![img](.images/download) **说明：**

  建议配置BFD会话的等待恢复时间(WTR)。

##### 非规范配置的风险

**风险描述**

IP-Trunk成员接口没有绑定BFD会话，IP-Trunk成员口发生链路故障时不能及时发现，业务不能及时切换。

如果IP-Trunk成员接口绑定BFD会话时，建议使能BFD会话的等待恢复时间（WTR）功能，避免因BFD会话频繁震荡，影响业务收敛。

**风险的判断方法**

1. 查看IP-Trunk成员口是否绑定BFD会话。

   如下回显表示：

   - IP-Trunk1的成员口POS1/0/0绑定了BFD会话且配置了WTR功能
   - IP-Trunk1的成员口POS1/0/1绑定了BFD会话，但未配置WTR功能。
   - IP-Trunk2的两个成员口均未绑定BFD会话。

   因此，IP-Trunk1、IP-Trunk2都存在本案例描述的问题。

   \# 查看IP-Trunk的成员口。

   ```
   <HUAWEI> display interface ip-trunk 1
   ```

   ```
   Ip-Trunk1 current state : DOWN                                                  
   Line protocol current state : DOWN                                              
   Link quality grade : --                                                         
   Description:HUAWEI, Ip-Trunk1 Interface                                         
   Route Port,Hash arithmetic : According to flow,Maximal BW: 311M, Current BW: 0M,
    The Maximum Transmit Unit is 4470                                              
   Internet protocol processing : disabled Link layer protocol is nonstandard HDLC 
   Physical is IP_TRUNK                                                            
   Current system time: 2017-03-28 17:10:01-08:00                                  
       Last 300 seconds input rate 0 bits/sec, 0 packets/sec                       
       Last 300 seconds output rate 0 bits/sec, 0 packets/sec                      
       Realtime 0 seconds input rate 0 bits/sec, 0 packets/sec                     
       Realtime 0 seconds output rate 0 bits/sec, 0 packets/sec                    
       Input: 0 packets,0 bytes                                                    
              0 unicast,0 broadcast,0 multicast                                    
              0 errors,0 unknownprotocol                                           
       Output:0 packets,0 bytes                                                    
              0 unicast,0 broadcast,0 multicast                                    
              0 errors                                                             
       Input bandwidth utilization  :    0%                                        
       Output bandwidth utilization :    0%                                        
   -----------------------------------------------------                           
   PortName                      Status      Weight                                
   -----------------------------------------------------                           
   Pos1/0/0                      DOWN        1                                     
   Pos1/0/1                      DOWN        1                                     
   -----------------------------------------------------            
   ```

   ```
   <HUAWEI> display interface ip-trunk 2
   ```

   ```
   Ip-Trunk2 current state : DOWN                                                  
   Line protocol current state : DOWN                                              
   Link quality grade : --                                                         
   Description:HUAWEI, Ip-Trunk2 Interface                                         
   Route Port,Hash arithmetic : According to flow,Maximal BW: 311M, Current BW: 0M,
    The Maximum Transmit Unit is 4470                                              
   Internet protocol processing : disabled Link layer protocol is nonstandard HDLC 
   Physical is IP_TRUNK                                                            
   Current system time: 2017-03-28 17:15:51-08:00                                  
       Last 300 seconds input rate 0 bits/sec, 0 packets/sec                       
       Last 300 seconds output rate 0 bits/sec, 0 packets/sec                      
       Realtime 99 seconds input rate 0 bits/sec, 0 packets/sec                    
       Realtime 99 seconds output rate 0 bits/sec, 0 packets/sec                   
       Input: 0 packets,0 bytes                                                    
              0 unicast,0 broadcast,0 multicast                                    
              0 errors,0 unknownprotocol                                           
       Output:0 packets,0 bytes                                                    
              0 unicast,0 broadcast,0 multicast                                    
              0 errors                                                             
       Input bandwidth utilization  :    0%                                        
       Output bandwidth utilization :    0%                                        
   -----------------------------------------------------                           
   PortName                      Status      Weight                                
   -----------------------------------------------------                           
   Pos1/0/2                      DOWN        1                                     
   Pos1/0/3                      DOWN        1                                     
   -----------------------------------------------------                           
   The Number of Ports in Trunk : 2                                                
   The Number of UP Ports in Trunk : 0                                             
   ```

   \# 查看IP-Trunk所有成员口是否绑定BFD会话

   ```
   <HUAWEI> display current-configuration configuration bfd-session
   ```

   ```
   #                                                                               
   bfd BFD-IPtrunk1-1 bind peer-ip default-ip interface Pos1/0/0                   
    discriminator local 6013                                                       
    discriminator remote 6213                                                      
    wtr 10                                                                         
    process-interface-status                                                       
    commit                                                                         
   #                                                                               
   //IP-Trunk成员口Pos1/0/0绑定了BFD会话且配置了BFD会话的等待恢复时间
   bfd BFD-IPtrunk1-2 bind peer-ip default-ip interface Pos1/0/1                   
    discriminator local 6010                                                       
    discriminator remote 6213                                                      
    process-interface-status                                                       
    commit                                                                         
   #
   //IP-Trunk成员口Pos1/0/1未配置BFD会话的等待恢复时间  
   //IP-trunk2的成员Pos1/0/2、Pos1/0/3未绑定BFD                                      
   return   
   ```

**风险的恢复方案**

配置IP-Trunk成员口绑定BFD会话，并配置BFD会话的等待恢复时间。

- IP-Trunk1的成员口POS1/0/1配置BFD会话的等待恢复时间。

  ```
  <HUAWEI> system-view
  ```

  ```
  [HUAWEI] bfd BFD-IPtrunk1-2
  ```

  ```
  [HUAWEI-bfd-session-BFD-IPtrunk1-2] wtr 10
  ```

- IP-Trunk2的成员口POS1/0/2及POS1/0/3绑定BFD会话且配置BFD会话的等待恢复时间。

  ```
  <HUAWEI> system-view
  ```

  ```
  [HUAWEI] bfd BFD-Iptrunk2-1 bind peer-ip default-ip interface Pos1/0/2
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-1] discriminator local 6000
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-1] discriminator remote 6001
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-1] wtr 10
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-1] process-interface-status
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-1] commit
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-1] quit
  ```

  ```
  [HUAWEI] bfd BFD-Iptrunk2-2 bind peer-ip default-ip interface Pos1/0/3
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-2] discriminator local 6002
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-2] discriminator remote 6003
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-2] wtr 10
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-2] process-interface-status
  ```

  ```
  [HUAWEI-bfd-session-BFD-Iptrunk2-2] commit
  ```
