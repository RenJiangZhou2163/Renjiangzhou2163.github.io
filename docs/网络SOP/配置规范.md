# 配置规范

!!! note

    **说明：** 本文档介绍了NE系列路由器在某些应用场景中的配置规范，此规范要求用户在NE系列路由器部分特性的配置与维护时，必须按照配置规范要求进行业务部署，避免因错误配置、错误使用或可靠性缺失造成业务中断。


## 1.9 MPLS

### 1.9.1 MPLS LDP 的配置规范

#### 1.9.1.1 多链路或本远共存场景的参数配置规范

两个LSR之间存在多条链路或本远共存时，LDP会话最终只能建立在一条链路上或者无法建立成功。

##### 应用场景1–两个LSR之间存在多链路的场景

**图1-12** 多链路组网图
![img](.images/download)

##### 应用场景2–两个LSR之间存在本远共存的场景

**图1-13** 本远共存组网图
![img](.images/download)

##### 应用场景3–两个LSR之间既存在多链路场景又存在本远共存的场景

**图1-14** 多链路与本远共存组网图
![img](.images/download)

##### 配置规范

上述场景中，LDP接口视图和LDP远端对等体视图中参数需配置一致。

1. 如果同一个LDP对等体的所有本地接口视图中，部分配置了**mpls ldp transport-address**命令，或全部都配置了**mpls ldp transport-address**命令但没有指定相同的接口地址，则需要将所有本地接口的传输地址指定成同一个地址或者全都不配置以使用默认值。
2. 如果同一个私网LDP对等体的所有本地接口视图中，没有全部指定相同的传输地址**mpls ldp transport-address**命令，则需要将所有本地接口的传输地址指定成同一个地址。
3. 如果同一个LDP对等体的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp timer keepalive-hold**命令，或者全部都配置了**mpls ldp timer keepalive-hold**命令但没有指定相同的参数，则需要将所有本地接口视图和LDP远端对等体视图的keepalive-hold参数配置相同值或者全都不配置以使用默认值。
4. 如果同一个LDP Peer的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp timer keepalive-send**命令，或者全部都配置了**mpls ldp timer keepalive-send**命令但没有指定相同的参数，则需要将所有本地接口视图和LDP远端对等体视图的keepalive-send参数配置相同值或者全都不配置以使用默认值。
5. 如果同一个LDP对等体的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp advertisement**命令，或者全部都配置了**mpls ldp advertisement**命令但没有指定相同的参数，则需要将所有本地接口视图和LDP远端对等体视图的标签发布模式指定成同一种或者全都不配置以使用默认值。
6. 如果同一个LDP对等体的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp local-lsr-id**命令，或者全部都配置了**mpls ldp local-lsr-id**命令但没有指定相同的接口地址，则需要将所有本地接口视图和LDP远端对等体视图的local-lsr-id指定成同一个地址或者全都不配置以使用默认值。

##### 非规范配置的风险

**风险描述**

用户视图下，执行命令**display mpls ldp adjacency all**，如果查看到设备上存在Peer ID相同的LDP邻接体，则LDP会话的部分发现源无法绑定，导致不能形成负载分担的LDP LSP或者本远共存会话保护，而且由于LDP会话建立不成功会导致承载业务受损。

**风险的判断方法**

1. 在任意视图下，执行命令**display mpls ldp adjacency all**查询LDP邻接体信息。如果没有回显信息，则说明不涉及本问题。否则需要继续检查。

   如下显示中，加粗字体表示相同Peer ID存在多链路或本远共存的情况，需要排查1.1.1.2、1.1.1.3和6.6.6.6的Peer ID。

   ```
   <HUAWEI> display mpls ldp adjacency all
   ```

   ```
   LDP Adjacency Information in Public Network                                           
   ```

   ```
    Codes: R: Remote Adjacency, L: Local Adjacency                                        
   ```

   ```
    A '*' before an adjacency means the adjacency is being deleted.                       
   ```

   ```
    ------------------------------------------------------------------------------        
   ```

   ```
    SN    SourceAddr      PeerID       VrfID AdjAge(DDDD:HH:MM) RcvdHello Type         
   ```

   ```
    ------------------------------------------------------------------------------        
   ```

   ```
     1    2.2.2.1        1.1.1.2       0     0000:00:37         449       L            
   ```

   ```
     2    2.2.1.1        1.1.1.4       0     0000:00:04         57        L            
   ```

   ```
     3    1.1.1.2       1.1.1.2       0     0000:00:09         148       R
   ```

   ```
     4    3.3.3.3        1.1.1.2       0     0000:00:00         11        L            
   ```

   ```
     5    2.2.3.1        1.1.1.3       0     0000:00:20         258       L 
   ```

   ```
     6    1.1.1.2       1.1.1.3       0     0000:00:20         76        R           
   ```

   ```
    ------------------------------------------------------------------------------       
   ```

   ```
   LDP Adjacency Information in VPN-Instance: vpn1
   ```

   ```
    Codes: R: Remote Adjacency, L: Local Adjacency
   ```

   ```
    A '*' before an adjacency means the adjacency is being deleted.
   ```

   ```
    ------------------------------------------------------------------------------
   ```

   ```
    SN    SourceAddr    PeerID        VrfID AdjAge(DDDD:HH:MM) RcvdHello Type
   ```

   ```
    ------------------------------------------------------------------------------
   ```

   ```
     1    2.3.2.1        6.6.6.6         1     0000:00:08         103       L
   ```

   ```
     2    2.4.2.1        6.6.6.6         1     0000:00:02         33        L
   ```

   ```
    ------------------------------------------------------------------------------
   ```

   ```
   TOTAL: 8 Record(s) found.            
   ```

2. 对相同Peer ID的多个邻接体进行排查。

   \# 如果是本地邻接体，在任意视图下执行命令**display ip routing-table** *ip-address*查看对应的出接口。以Peer ID为1.1.1.2为例，有两个本地邻接体2.2.2.1和3.3.3.3，有一个远端邻接体1.1.1.2。

   ```
   <HUAWEI> display ip routing-table 2.2.2.1      
   ```

   ```
   Route Flags: R - relay, D - download to fib                  
   ```

   ```
   ------------------------------------------------------------------------------         
   ```

   ```
   Routing Table : Public                    
   ```

   ```
   Summary Count : 1                         
   ```

   ```
   Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface   
   ```

   ```
   2.2.2.1/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/0           
   ```

   \# 在任意视图下执行命令**display current-configuration interface** *interface-type interface-number*查看接口的配置信息。如下显示信息说明接口下使能了LDP。

   ```
   <HUAWEI> display current-configuration interface GigabitEthernet 1/0/0         
   ```

   ```
   #                                         
   ```

   ```
   interface GigabitEthernet1/0/0            
   ```

   ```
    undo shutdown                            
   ```

   ```
    ip address 2.2.2.1 255.255.255.0        
   ```

   ```
    isis enable 1                            
   ```

   ```
    mpls                                     
   ```

   ```
    mpls ldp    
   ```

   ```
    dcn                                      
   ```

   ```
   #                                         
   ```

   \# 如果是私网路由，在任意视图下执行命令**display ip routing-table vpn-instance** *vpn-instance-name* *ip-address*，查看对应的出接口。

   ```
   <HUAWEI> display ip routing-table vpn-instance vpn1 2.3.2.1
   ```

   ```
   Route Flags: R - relay, D - download to fib
   ```

   ```
   ------------------------------------------------------------------------------
   ```

   ```
   Routing Table : vpn1
   ```

   ```
   Summary Count : 1
   ```

   ```
   Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface
   ```

   ```
   2.4.2.0/24         Direct  0    0           D   10.5.6.5        Ethernet0/0/1
   ```

   ```
   
   ```

   \# 如果是远端邻接体，在任意视图下执行命令**display mpls ldp remote-peer peer-id** *lsr-id*，查看对应的LDP远端对等体视图名称。

   ```
   <HUAWEI> display mpls ldp remote-peer peer-id 1.1.1.2                          
   ```

   ```
                                             
   ```

   ```
                            LDP Remote Entity Information                                 
   ```

   ```
    ------------------------------------------------------------------------------        
   ```

   ```
    Remote Peer Name  : 5to3 
   ```

   ```
    Remote Peer IP    : 1.1.1.2          LDP ID        : 1.1.1.1:0                    
   ```

   ```
    Transport Address : 1.1.1.1          Entity Status : Active                         
   ```

   ```
                                             
   ```

   ```
    Configured Keepalive Hold Timer : 45 Sec 
   ```

   ```
    Configured Keepalive Send Timer : ---    
   ```

   ```
    Configured Hello Hold Timer     : 45 Sec 
   ```

   ```
    Negotiated Hello Hold Timer     : 45 Sec 
   ```

   ```
    Configured Hello Send Timer     : ---    
   ```

   ```
    Configured Delay Timer          : 10 Sec 
   ```

   ```
    Hello Packet sent/received      : 272/271
   ```

   ```
    Label Advertisement Mode        : Downstream Unsolicited                              
   ```

   ```
    Remote Peer Deletion Status     : No     
   ```

   ```
    Auto-config                     : ---    
   ```

   ```
    ------------------------------------------------------------------------------        
   ```

   \# 在任意视图下执行命令**display current-configuration configuration mpls-ldp-remote** *name*查看LDP远端对等体视图的配置信息。如下显示信息表示配置了远端邻接体。

   ```
   <HUAWEI> display current-configuration configuration mpls-ldp-remote 5to3           
   ```

   ```
   #                                         
   ```

   ```
   mpls ldp remote-peer 5to3                    
   ```

   ```
    remote-ip 1.1.1.2  
   ```

   ```
   #                                         
   ```

   ```
   return                                    
   ```

3. 根据上面方法找到的接口视图或LDP远端对等体视图下存在如下列举的任意情况，即表明可能存在本问题。

   1. 同一个LDP对等体的所有本地接口视图中，部分配置了**mpls ldp transport-address**命令，或者全部都配置了**mpls ldp transport-address**命令但没有指定相同的接口地址。
   2. 同一个私网LDP对等体的所有本地接口视图中，没有通过**mpls ldp transport-address**命令全部指定相同的传输地址。
   3. 同一个LDP对等体的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp timer keepalive-hold**命令，或者全部都配置了**mpls ldp timer keepalive-hold**命令但没有指定相同的参数。
   4. 同一个LDP对等体的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp timer keepalive-send**命令，或者全部都配置了**mpls ldp timer keepalive-send**命令但没有指定相同的参数。
   5. 同一个LDP对等体的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp advertisement**命令，或者全部都配置了**mpls ldp advertisement**命令但没有指定相同的参数。
   6. 同一个LDP对等体的所有本地接口视图和LDP远端对等体视图中，部分配置了**mpls ldp local-lsr-id**命令，或者全部都配置了**mpls ldp local-lsr-id**命令但没有指定相同的接口地址。

**风险的恢复方案**

请按照配置规范进行配置。

#### 1.9.1.2 接口下需要配置LDP-IGP联动

设备的接口上使能了LDP能力但未使能LDP-IGP联动，在LDP会话震荡或链路故障恢复业务回切等场景中，导致LDP隧道承载的业务受损或中断。

##### 应用场景

由于LDP的收敛速度依赖于IGP路由的收敛，即LDP的收敛速度比IGP的收敛速度慢，因此如[图1-15](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_004101)所示，存在主备链路的组网中有如下问题：

- 当主链路发生故障时，IGP路由和LSP均切换到备份链路上（常通过LDP FRR实现）。但当主链路从故障中恢复时，IGP会先于LDP切换回主链路，因此造成LSP流量丢失。
- 当主链路IGP运行正常，但主链路节点间的LDP会话发生故障时，IGP路由仍然使用主链路，而主链路的LSP被删除。同时，由于备份链路不存在IGP优选路由，故LSP无法在备份链路建立，导致LSP流量丢失。

**图1-15** LDP接口下没有配置LDP-IGP联动导致业务受损组网图
![img](.images/download)

##### 配置规范

配置了MPLS LDP能力的接口视图下补充配置LDP和IGP同步功能，并将hold-max-cost定时器的值配置为infinite。常见的IGP协议包含IS-IS和OSPF，可根据现网业务需要决定配置哪种协议对应的联动能力。

##### 非规范配置的风险

**风险描述**

在任意视图下，执行命令**display current-configuration interface**，查看配置了LDP能力的接口，发现接口下没有配置LDP和IGP同步功能。此时，如果在用户视图下，执行命令**display mpls lsp protocol ldp include** *ip-address* **32**查询不到信息，表明承载业务的LDP LSP未建立成功。在LDP会话震荡或链路故障恢复业务回切等场景中，会出现LDP LSP承载的业务恢复较慢或长时间不能恢复，导致LDP LSP承载的业务受损或中断。

**风险的判断方法**

在任意视图下，执行命令**display current-configuration interface**查看接口配置。如果接口视图下仅配置了MPLS LDP，但没有配置LDP和IGP同步功能，则可能存在问题。

如下显示信息说明接口视图下配置了MPLS LDP，同时配置了LDP和IS-IS同步功能命令、LDP和OSPF同步功能命令。

<HUAWEI> **display current-configuration interface**

```
#
interface GigabitEthernet1/0/0                            
 undo shutdown                                            
 mtu 9192                                                 
 ip address 10.1.1.1 255.255.255.0                        
 isis enable 1 
isis ldp-sync                                           
 isis timer ldp-sync hold-max-cost infinite               
 ospf ldp-sync                                             
 ospf timer ldp-sync hold-max-cost infinite                                              
 mpls                                                     
 mpls ldp                                          
 dcn                                                      
 negotiation auto                                         
#                   
……
```

**风险的恢复方案**

配置了MPLS LDP能力的接口视图下补充配置LDP和IGP同步功能，并将hold-max-cost定时器的值配置为infinite。

```
<HUAWEI> display current-configuration interface
#
interface GigabitEthernet1/0/0                            
 undo shutdown                                            
 mtu 9192                                                 
 ip address 10.1.1.1 255.255.255.0                        
 isis enable 1 
isis ldp-sync                  
 isis timer ldp-sync hold-max-cost infinite               
 ospf ldp-sync                                            
 ospf timer ldp-sync hold-max-cost infinite                                              
 mpls           
 mpls ldp          
……
```

### 1.9.2 MPLS TE 的配置规范

#### 1.9.2.1 跨IGP域建立TE隧道需要配置显示路径

建立TE隧道经过多个IGP域时，需要隧道配置包含跨域节点IP地址的显示路径，同时隧道Ingress节点和跨域节点都使能CSPF，否则，隧道可能建立失败。

##### 应用场景

跨IGP域建立TE隧道。

**图1-16** 跨IGP域建立TE隧道组网图
![img](.images/download)

如[图1-16](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_004301)所示，TE隧道从RouterA建到RouterD，其中RouterA出接口、RouterB入接口属于IGP Area1，RouterB出接口和RouterC入接口属于IGP Area2，RouterC出接口和RouterD入接口属于IGP Area3，RouterB和RouterC为跨域节点。

##### 配置规范

建立TE隧道经过多个IGP域时，需要隧道配置包含跨域节点IP地址的显示路径，同时隧道Ingress节点和跨域节点设备都使能CSPF。

##### 非规范配置的风险

**风险描述**

建立TE隧道经过多个IGP域时，如果隧道没有配置包含跨域节点IP地址的显示路径且隧道经过的各设备都配置了CSPF，则会导致隧道建立失败。

##### 风险的判断方法

1. 在用户视图下，执行**display current-configuration configuration mpls**命令，查看全局MPLS配置。

   由以下显示信息可以看出，配置了MPLS TE和MPLS TE CSPF。

   ```
   <HUAWEI> display current-configuration configuration mpls
   #
   mpls lsr-id 1.1.1.1
   #
   mpls
    mpls te
    mpls rsvp-te
    mpls te cspf 
   #
   return
   ```

2. 用户视图下，执行**display current-configuration interface** *interface-type interface-number*命令，查看隧道的配置信息，获取隧道的目的地址和显式路径。

   由以下显示信息可以看出，隧道的目的地址为4.4.4.4,显示路径为huawei。

   ```
   <HUAWEI> display current-configuration interface Tunnel 0/0/1
   #
   interface Tunnel0/0/1
    tunnel-protocol mpls te
    destination 4.4.4.4 
    mpls te record-route
    mpls te backup hot-standby
    mpls te tunnel-id 1
    mpls te path explicit-path huawei
   #
   return
   ```

3. 在用户视图下，执行**display mpls te cspf tedb all**命令，查看CSPF TEDB信息，如果没有隧道的目的地址，就可以确定是IGP跨域场景。

   由以下显示信息可以看出，TEDB没有4.4.4.4的信息，是IGP跨域场景。

   ```
   <HUAWEI> display mpls te cspf tedb all
   Maximum Nodes Supported: 2000    Current Total Node Number: 4
   Maximum Links Supported: 8000    Current Total Link Number: 6
   Maximum SRLGs supported: 10000   Current Total SRLG Number: 0
   Id     Router-Id        IGP      Process-Id     Area            Link-Count
   1      1.1.1.1          ISIS     1              Level-1         2         
   2      2.2.2.2          ISIS     1              Level-1         1         
   3      1.1.1.1          ISIS     1              Level-2         2         
   4      2.2.2.2          ISIS     1              Level-2         1 
   ```

4. 检查隧道的显示路径是否正确。

   - 如果没有配置显示路径，需要配置包含跨IGP域节点IP地址的显示路径。
   - 如果配置了显示路径，用户视图下，执行**display current-configuration configuration explicit-path** *explicit-name*命令，查看显示路径信息，确认显示路径是否包含跨IGP域节点的IP地址。

   ```
   <HUAWEI> display current-configuration configuration explicit-path test
   #
   explicit-path test
    next hop 192.168.1.2 include loose 
   #
   ```

##### 风险的恢复方案

请按照配置规范进行配置。

#### 1.9.2.2 RSVP-TE GR功能需要在RSVP-TE接口下配置RSVP-TE Hello

部署RSVP-TE GR时，全局MPLS视图下配置**mpls rsvp-te hello support-peer-gr**或**mpls rsvp-te hello full-gr**后，还需要在使能了RSVP-TE的接口下配置**mpls rsvp-te hello**。

##### 应用场景

部署RSVP-TE GR场景，详细场景描述请参见配置RSVP GR。

##### 配置规范

部署RSVP-TE GR时，RSVP-TE接口下需要配置RSVP-TE Hello。

##### 非规范配置的风险

**风险描述**

RSVP-TE接口下没有配置RSVP-TE Hello，会导致RSVP-TE GR功能失效，当RSVP节点进行主备倒换时，该节点与邻居之间的RSVP邻接关系会因信令协议超时而被拆除，从而删除CR-LSP，导致CR-LSP承载的业务出现中断。

##### 风险的判断方法

1. 在用户视图下，执行**display current-configuration configuration mpls**命令，查看全局MPLS配置中是否配置了**mpls rsvp-te hello support-peer-gr**或者**mpls rsvp-te hello full-gr**，以判断是否部署了GR。以下显示说明部署了GR。

   ```
   <HUAWEI> display current-configuration configuration mpls
   ```

   ```
   #
   mpls lsr-id 1.1.1.1
   #
   mpls
    mpls te
    mpls rsvp-te
    mpls rsvp-te hello
    mpls rsvp-te hello support-peer-gr
    mpls te cspf
   #
   return
   ```

2. 在用户视图下，执行**display current-configuration interface**命令，查看接口是否配置了**mpls rsvp-te hello**。如果接口下没有配置**mpls rsvp-te hello**，则说明存在该案例描述的问题。

   ```
   <HUAWEI> display current-configuration interface
   #
   interface Ethernet3/0/0
    undo shutdown
    ip address 192.168.21.1 255.255.255.0
    isis enable 1
    mpls
    mpls te
    mpls te bandwidth max-reservable-bandwidth 100000
    mpls te bandwidth bc0 100000
    mpls rsvp-te
    mpls rsvp-te hello
   # 
   ```

##### 风险的恢复方案

**恢复措施**

在Ethernet3/0/0接口视图下执行**mpls rsvp-te hello**命令，启动接口的Hello机制。

#### 1.9.2.3 IGP多进程或多区域场景CSPF算路与预期不符

设备上部署多个使能了MPLS TE的IGP进程时，CSPF在计算TE隧道路径时，不能在多个IGP进程之间计算出最优路径，在单个进程内计算出的最优路径不能保证与客户的预期路径一致，可能导致TE隧道承载的业务拥塞或中断。

##### 应用场景

如[图1-17](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_004601)所示，设备上部署TE隧道，隧道可能经过的多条路径分属不同的IGP进程。

以IS-IS协议为例，TE隧道从ASG1建到RSG1，头尾节点之间的路径中存在多个IS-IS进程（IS-IS 1000、IS-IS 2119）。正常情况下隧道路径如[图1-17](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_004601)红色线所示，当接入环IS-IS 2119发生路由震荡，等到TE重优化时间后，隧道路径绕行CSG，如[图1-17](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_004601)蓝色线所示。

**图1-17** IGP多进程或多区域场景CSPF算路与预期不符问题组网图
![img](.images/download)

##### 配置规范

IGP多进程使能了MPLS TE时，会先后通知CSPF更新TEDB信息。CSPF在计算TE隧道路径时，以最后更新到TEDB中的IGP进程为准。不能在多个IGP进程之间通过比较不同进程的IGP Cost来计算出最优路径，而在单个进程内计算出的最优路径不能保证与客户的预期路径一致。

在配置时，主要有以下两种方案。

1. 主用方案：系统视图下配置显式路径，并在TE隧道下使用该显式路径。显式路径名称pri1为例。

   \# 在系统视图下，执行命令**explicit-path** **pri1**配置显式路径。

   ```
   <HUAWEI> system-view
   [HUAWEI] explicit-path pri1 
   ```

   \# TE隧道接口视图下，执行命令**mpls te path explicit-path** **pri1**配置显式路径。

   ```
   [HUAWEI] interface Tunnel 0/0/1
   [HUAWEI-Tunnel0/0/1] tunnel-protocol mpls te
   [HUAWEI-Tunnel1/0/0] mpls te path explicit-path pri1
   [HUAWEI-Tunnel1/0/0] mpls te commit
   ```

   ![img](.images/download) **说明：**

   如果现网存在IGP跨域的场景，在配置显式路径时需要包含跨域边界的设备，且在该设备上需要使能CSPF。

   Hot-Standby LSP也需要配置显式路径约束，否则在同样场景下也可能存在本问题。

2. 备选方案：在MPLS视图下配置**mpls te cspf preferred-igp**命令，使CSPF在算路时可以优先选择指定的IGP进程。

   \# 如果IGP路由使用ISIS分进程方案，则在MPLS视图下，使用命令行**mpls te cspf preferred-igp** **isis 1**配置优选ISIS进程。

   ```
   <HUAWEI> system-view
   [HUAWEI] mpls
   [HUAWEI-mpls] mpls te cspf preferred-igp isis 1
   ```

   \# 如果IGP路由使用OSPF分进程方案，则在MPLS视图下，使用命令行**mpls te cspf preferred-igp** **ospf 1 area 0.0.0.0**配置优选OSPF进程和域（参数area不是必配）。

   ```
   <HUAWEI> system-view
   [HUAWEI] mpls
   [HUAWEI-mpls] mpls te cspf preferred-igp ospf 1 area 0.0.0.0
   ```

   ![img](.images/download) **说明：**

   本方案只建议用作备选方案。因为即使配置了优选的IGP进程，若CSPF使用优选的IGP进程算路失败（链路临时有震荡等问题），会继续选择其他进程进行算路。若此时用其他进程算路成功，则会创建LSP，而想要切回到优选的IGP进程中，则需要等待TE重优化，触发CSPF重新算路。因此本方案并不一定能彻底解决本问题。

   另外，配置的优选进程只能配置一个。如果不同TE隧道需要优选的IGP进程不同（比如RSG属于多个汇聚环，每个汇聚环的IGP进程都不同）的情况下，不适用本方案。

##### 非规范配置的风险

**风险描述**

如果源宿设备上部署了TE隧道和IGP多进程，且源宿设备上的TE隧道路径为根据IGP路径自动计算，未部署显式路径或者其它约束，则会导致TE隧道经过的路径与预期不一致，业务拥塞或中断。

##### 风险的判断方法

1. 查询是否使能MPLS TE/RSVP-TE/CSPF。

   \# 在用户视图下，执行命令**display current-configuration configuration mpls**。在使能了MPLS TE、RSVP-TE以及CSPF的情况下，可能会出现本案例描述的问题，需要进一步进行检查；如果没有使能其中任意一项，则问题不存在。

   ```
   <HUAWEI> display current-configuration configuration mpls
   ```

   ```
   #
   ```

   ```
   mpls lsr-id 2.2.2.2
   ```

   ```
   mpls
   ```

   ```
    mpls te 
   ```

   ```
    mpls rsvp-te 
   ```

   ```
    mpls te cspf 
   ```

   ```
   #
   ```

   ```
   return
   ```

2. 查询是否存在多个IS-IS/OSPF进程。

   \# 在用户视图下，使用命令行**display current-configuration configuration isis**或**display current-configuration configuration ospf**。如果存在多个IS-IS/OSPF进程，可能会存在问题，还需要进一步进行检查。

   ```
   <HUAWEI> display current-configuration configuration isis
   ```

   ```
   #
   ```

   ```
   isis 1 
   ```

   ```
    is-level level-2
   ```

   ```
    cost-style wide
   ```

   ```
    network-entity 10.0000.0002.0001.00
   ```

   ```
    traffic-eng level-2
   ```

   ```
   #
   ```

   ```
   isis 2 
   ```

   ```
    is-level level-2
   ```

   ```
    cost-style wide
   ```

   ```
    network-entity 10.0000.0002.0002.00
   ```

   ```
    traffic-eng level-2
   ```

   ```
   
   ```

   ```
   …
   ```

   ```
   #
   ```

   ```
   <HUAWEI> display current-configuration configuration ospf
   ```

   ```
   #
   ```

   ```
   ospf 1
   ```

   ```
    opaque-capability enable
   ```

   ```
    area 0.0.0.0
   ```

   ```
     network 1.1.1.2 0.0.0.0
   ```

   ```
     network 2.2.2.1 0.0.0.0
   ```

   ```
     network 11.2.1.0 0.0.0.255
   ```

   ```
     network 20.20.20.20 0.0.0.0
   ```

   ```
     mpls-te enable
   ```

   ```
   #
   ```

   ```
   ospf 2
   ```

   ```
    area 0.0.0.0
   ```

   ```
     network 101.1.10.0 0.0.0.255
   ```

   ```
     network 101.1.11.0 0.0.0.255
   ```

   ```
   …
   ```

3. 查询IS-IS/OSPF下是否使能了TE。

   \# 使用的命令和视图与步骤2相同。如果超过1个IS-IS/OSPF进程使能了TE，可能会存在问题，还需要继续步骤5的检查；如果只有1个OSPF进程使能TE，还需要继续步骤4的检查；如果仅配置1个IS-IS进程使能TE，则不存在问题。

   ```
   <HUAWEI> display current-configuration configuration isis
   ```

   ```
   #
   ```

   ```
   isis 1
   ```

   ```
    is-level level-2
   ```

   ```
    cost-style wide
   ```

   ```
    network-entity 10.0000.0002.0001.00
   ```

   ```
    traffic-eng level-2 
   ```

   ```
   #
   ```

   ```
   <HUAWEI> display current-configuration configuration ospf
   ```

   ```
   #
   ```

   ```
   ospf 1
   ```

   ```
    opaque-capability enable
   ```

   ```
    area 0.0.0.0
   ```

   ```
     network 1.1.1.2 0.0.0.0
   ```

   ```
     network 2.2.2.1 0.0.0.0
   ```

   ```
     network 11.2.1.0 0.0.0.255
   ```

   ```
     network 20.20.20.20 0.0.0.0
   ```

   ```
     mpls-te enable 
   ```

4. 查询OSPF是否配置了多个域。

   \# 在用户视图下，执行命令**display current-configuration configuration ospf**。如果存在多个OSPF区域，且每个域都使能了MPLS TE，可能会存在问题，则需要进一步进行检查。

   ```
   <HUAWEI> display current-configuration configuration ospf
   ```

   ```
   #
   ```

   ```
   ospf 1
   ```

   ```
    opaque-capability enable
   ```

   ```
    area 0.0.0.0 
   ```

   ```
     network 1.1.1.2 0.0.0.0
   ```

   ```
     mpls-te enable 
   ```

   ```
   area 0.0.0.9
   ```

   ```
    network 1.1.1.9 0.0.0.0
   ```

   ```
    mpls-te enable
   ```

5. 查询隧道实际经过的路径。

   查询出隧道实际经过的路径后，对比规划的路径，查看是否一致，若不一致，则表明出现了本案例描述的问题。

   - 在用户视图下，执行命令**display current-configuration interface Tunnel 0/0/1**查询是否配置了记录路由。隧道接口以Tunnel0/0/1为例。

     ```
     <HUAWEI> display current-configuration interface Tunnel 0/0/1
     ```

     ```
     #
     ```

     ```
     interface Tunnel0/0/1
     ```

     ```
      tunnel-protocol mpls te
     ```

     ```
      destination 4.4.4.4
     ```

     ```
      mpls te record-route label    
     ```

     ```
      mpls te backup hot-standby 
     ```

     ```
      mpls te tunnel-id 111
     ```

     ```
     #
     ```

     ```
     Return
     ```

     ```
     
     ```

   - 如果配置了**mpls te record-route label**命令，则在用户视图下，执行命令**display mpls te tunnel path Tunnel0/0/1**查询隧道实际经过的路径。

     ```
     <HUAWEI> display mpls te tunnel path Tunnel0/0/1
     ```

     ```
      Tunnel Interface Name : Tunnel0/0/1
     ```

     ```
      Lsp ID : 3.3.3.3 :100 :3 
     ```

     ```
      Hop Information 
     ```

     ```
       Hop 0   3.3.3.3 
     ```

     ```
       Hop 1   10.1.1.1 
     ```

     ```
       Hop 2   10.1.1.2 
     ```

     ```
       Hop 3   2.2.2.2 
     ```

     ```
     
     ```

   - 如果没有配置**mpls te record-route label**命令，则用户视图下，执行命令**tracert lsp te Tunnel 0/0/1**查询隧道实际经过的路径。

     ```
     <HUAWEI> tracert lsp te Tunnel 0/0/1
     ```

     ```
       LSP Trace Route FEC: TE TUNNEL IPV4 SESSION QUERY Tunnel0/0/1, press CTRL_C to break.
     ```

     ```
       TTL   Replier            Time    Type      Downstream 
     ```

     ```
       0                                Ingress   10.1.2.1/[3 ]
     ```

     ```
       1     3.3.3.3            32 ms   Egress       
     ```

     ```
     
     ```

##### 风险的恢复方案

请按照配置规范进行配置。

#### 1.9.2.4 TE隧道建议部署在主控板

在网络部署TE隧道时，需要把TE隧道部署在主控板。如果部署在接口板，Tunnel所在接口板故障，会导致TE保护不生效，业务中断。

##### 应用场景

部署TE隧道。

##### 配置规范

在网络部署TE隧道时，把TE隧道部署在主控板。

##### 非规范配置的风险

如果TE Tunnel部署在接口板，且接口板故障或拔出，会导致TE保护不生效，业务中断。

##### 风险的判断方法

1. 在用户视图下，执行命令**display ip interface brief Tunnel**查看所有隧道接口，找到没有部署在主控板上的隧道接口。

   下面显示信息中，根据Tunnel接口编号发现Tunnel1/0/0部署在1号接口板，没有部署在主控板。

   ```
   <HUAWEI> display ip interface brief Tunnel
   *down: administratively down
   !down: FIB overload down
   ^down: standby
   (l): loopback
   (s): spoofing
   (d): Dampening Suppressed
   (E): E-Trunk down
   The number of interface that is UP in Physical is 181
   The number of interface that is DOWN in Physical is 0
   The number of interface that is UP in Protocol is 3
   The number of interface that is DOWN in Protocol is 178
                                                                                   
   Interface                         IP Address/Mask      Physical   Protocol      
   Tunnel0/0/1                       1.1.2.7/32           up         down          
   Tunnel0/0/2                       1.1.2.7/32           up         down          
   Tunnel0/0/3                       1.1.2.7/32           up         down          
   Tunnel0/0/4                       1.1.2.7/32           up         down          
   Tunnel0/0/5                       1.1.2.7/32           up         down          
   Tunnel0/0/6                       1.1.2.7/32           up         down          
   Tunnel0/0/7                       1.1.2.7/32           up         down          
   Tunnel1/0/0                       1.1.2.7/32           up         up         
   ```

2. 在用户视图下，执行>**display current-configuration interface** *interface-name*命令，查看没有部署在主控板上隧道接口的配置。

   以下显示信息说明该隧道是TE隧道，存在本案例描述的问题。

   ```
   <HUAWEI> display current-configuration interface Tunnel1/0/0
   #
   interface Tunnel1/0/0
    ip address unnumbered interface LoopBack0
    tunnel-protocol mpls te
    destination 1.1.2.9
    mpls te tunnel-id 2000
    mpls te commit
   ```

##### 风险的恢复方案

在网络部署TE隧道时，把TE隧道部署在主控板。

#### 1.9.2.5 TE Tunnel配置路由发布功能后，需要同时配置LDP Remote会话

LDP over TE场景下，TE Tunnel接口视图下配置**mpls te igp advertise**或**mpls te igp advertise shortcut**命令，使能路由发布功能后，针对该Tunnel的**destination**需要配置LDP Remote会话。

##### 应用场景

LDP over TE场景下，存在TE Tunnel接口，且该接口下配置了**mpls te igp advertise**或**mpls te igp advertise shortcut**命令。

##### 配置规范

LDP over TE场景下，TE Tunnel接口视图下配置**mpls te igp advertise**或**mpls te igp advertise shortcut**命令后，针对该Tunnel的**destination**需要配置LDP Remote会话。

##### 非规范配置的风险

**风险描述**

如果不配置LDP Remote会话，LDP LSP无法建立，导致业务中断。

**风险的判断方法**

1. 在用户视图，执行**display current-configuration** **interface** *interface-name*命令，查看Tunnel中存在**mpls te igp advertise**或**mpls te igp advertise shortcut**配置，并记录**destination**地址。

   ```
   <HUAWEI> display current-configuration interface Tunnel0/0/1
   #
   interface Tunnel0/0/1
    ip address unnumbered interface LoopBack0
    tunnel-protocol mpls te
    destination 10.1.1.1
    mpls te tunnel-id 2000
    mpls te igp advertise
    mpls te commit
   ```

2. 在用户视图，执行**display current-configuration** **configuration mpls-ldp-remote**命令，如果没有跟上述**destination**地址相同的**remote-ip**，则存在本案例中描述的风险。

   ```
   <HUAWEI> display current-configuration configuration mpls-ldp-remote 
   #
   mpls ldp remote-peer test
   remote-ip 10.10.10.1
   #
   return
   ```

**风险的恢复方案**

TE Tunnel接口视图下配置**mpls te igp advertise**或**mpls te igp advertise shortcut**命令后，针对该Tunnel的destination需要配置LDP Remote会话。

#### 1.9.2.6 TE FRR场景需要在旁路隧道的PLR(Point of Local Repair)节点和MP(Merge Point)节点间建立Hello会话的配置规范

对于部署TE FRR的网络，为了使节点在FRR和RSVP-TE GR同时发生故障的情况下保护主隧道，需要在旁路隧道的PLR(Point of Local Repair)节点和MP(Merge Point)节点间建立Hello会话。

##### 应用场景

部署TE FRR的网络。

##### 配置规范

对于部署TE FRR的网络，需要在旁路隧道的PLR(Point of Local Repair)节点和MP(Merge Point)节点间建立Hello会话，在MPLS视图下配置**mpls rsvp-te Hello nodeid-session** *ip-address*命令。

##### 非规范配置的风险

**风险描述**

如果不配置建立Hello会话，则不支持增强的RSVP GR功能，造成业务中断。

**风险的判断方法**

1. 在用户视图，执行**display current-configuration** **interface** *interface-name*命令，查看Tunnel中存在**mpls te fast-reroute**配置。

   ```
   <HUAWEI> display current-configuration interface Tunnel0/0/1
   #
   interface Tunnel1/0/0
    ip address unnumbered interface LoopBack0
    tunnel-protocol mpls te
    destination 1.1.2.9
    mpls te tunnel-id 2000
    mpls te fast-reroute
    mpls te commit
   ```

2. 在用户视图，执行**display current-configuration** **configuration mpls**命令，如果存在GR配置，但不存在mpls rsvp-te Hello nodeid-session ip-address配置，则存在案例描述的问题。

   ```
   <HUAWEI> display current-configuration configuration mpls
   #
    mpls lsr-id 2.2.2.2
    mpls
     mpls te
     mpls rsvp-te
     mpls rsvp-te Hello
     mpls rsvp-te Hello full-gr
     mpls rsvp-te Hello nodeid-session ip-address
     mpls te cspf
   ```

**风险的恢复方案**

在PLR(Point of Local Repair)节点和MP(Merge Point)节点上，mpls视图下配置**mpls rsvp-te Hello nodeid-session** *ip-address*命令（对于PLR节点，*ip-address*为MP节点的lsr-id；对于MP节点，*ip-address*为PLR节点的lsr-id）。

## 1.10 VPN

### 1.10.1 BGP/MPLS IP VPN 的配置规范

#### 1.10.1.1 B类型单板的L3VPN配置规范

B类型单板承载L3VPN业务必须激活对应的License，否则会导致L3VPN业务中断。

##### 应用场景

![img](.images/download) **说明：**

B类型单板指的是：

- 单板名称中有-B或者Unit B字样的单板。

单板名称可以使用display elabel中的Description字段显示出来。

1. **设备已经使用非B类型单板承载L3VPN业务，更换为B类型单板**
2. **设备已经使用B类型单板承载L3VPN业务，但License超期**
3. **设备使用B类型单板首次部署承载L3VPN业务**

##### 配置规范

**应用场景1-现网设备已经使用非B类型单板承载L3VPN业务，更换为B类型单板**

1. 根据待替换的B类型单板的具体型号，申请GTL License。具体申请方法，请咨询华为工程师。
2. 获取到License文件后，请传输到设备主用主控板CF卡的根目录。具体请参考：文件操作举例。如果存在备用主控板，还需要执行命令：**copy** *source-filename* **slave#cfcard:/** *destination-filename*，复制文件到备用主控板CF卡的根目录。
3. 激活License：**license active** *file-name*。
4. 设置下一次启动的License文件：**startup license**{ **default** | *file-name* } [ **slave-board** ]。
5. 更换单板，具体请参考：*部件更换->更换单板->更换业务处理板*。
6. 新单板上电后，执行命令：**service-enhance slot** *slot-id*。

**应用场景2-现网设备已经使用B类型单板承载L3VPN业务，但License超期**

1. 根据B类型单板的具体型号，申请GTL License。具体申请方法，请咨询华为工程师。
2. 获取到License文件后，请传输到设备主用主控板CF卡的根目录。具体请参考：文件操作举例。如果存在备用主控板，还需要执行命令：**copy** *source-filename* **slave#cfcard:/** *destination-filename*，复制文件到备用主控板CF卡的根目录。
3. 激活License：**license active** *file-name*。

**应用场景3-设备使用B类型单板首次部署承载L3VPN业务**

1. 安装单板并上电设备，具体请参考：*安装->安装单板与子卡*。
2. 根据待替换的B类型单板的具体型号，申请GTL License。具体申请方法，请咨询华为工程师。
3. 获取到License文件后，请传输到设备主用主控板CF卡的根目录。具体请参考：文件操作举例。如果存在备用主控板，还需要执行命令：**copy** *source-filename* **slave#cfcard:/** *destination-filename*，复制文件到备用主控板CF卡的根目录。
4. 激活License：**license active** *file-name*。
5. 执行命令：**service-enhance slot** *slot-id*。

##### 非规范配置的风险

**风险描述**

B类型单板默认不支持L3VPN，需要申请License并激活，并使能L3VPN功能后才能承载L3VPN业务。如果License缺失、未激活、超期，将会导致B类型单板承载的L3VPN业务中断。

**风险的判断方法**

- **应用场景1-现网设备已经使用非B类型单板承载L3VPN业务，更换为B类型单板**

  确定需要更换的单板上，是否承载L3VPN业务。执行**display fib** *slot-id* **statistics all**，查看对应槽位上的单板上是否有私网转发计数。例如：下面回显中，加粗的“IPv4 FIB VPN-instance 1 Route Prefix Count”、“IPv4 FIB VPN-instance 2 Route Prefix Count”、“IPv4 FIB VPN-instance dsc Route Prefix Count”后就有相应的计数，说明这台设备4号槽位上的单板上承载了L3VPN业务。需要更换前申请好License。

  ```
  <HUAWEI> display fib 4 statistics all
  IPv4 FIB Route Prefix Capacity : 3379199
  IPv4 FIB Total Route Prefix Count : 40; Entry Count : 41
  
  IPv4 FIB Public Route Prefix Count : 34; Entry Count : 35
  IPv4 FIB VPN-instance 1 Route Prefix Count : 1; Entry Count : 1
  IPv4 FIB VPN-instance 2 Route Prefix Count : 1; Entry Count : 1
  IPv4 FIB VPN-instance dsc Route Prefix Count : 4; Entry Count : 4
  ```

- **应用场景2-设备已经使用B类型单板承载L3VPN业务，但License超期**

  通过命令**display license**查看License有效期。例如：下面回显中字段“Expired date”显示的日期是否超过当前日期。如超期，需要申请License。

  ```
  <HUAWEI> display license 
  Active license : cfcard:/licortf201476-f2cffd7e56_me60.dat
  License state : Normal
  Revoke ticket : No ticket
  
  RD of Huawei Technologies Co., Ltd.
  
  Product name : ME60
  Product version : V600R008
  License Serial No : LIC2014081100D550
  Creator : Huawei Technologies Co., Ltd.
  Created Time : 2012-08-11 14:02:06
  Feature name : MEFEA
  Authorize type : COMM
  Expired date : 2017-08-11
  Trial days : --
  Feature name : MEFEB
  Authorize type : COMM
  Expired date : 2017-08-11
  Trial days : --
  
  Item name Item type Value Description
  -------------------------------------------------------------
  LME0NGMVPN Function YES Multicast NG MVPN
  LME0HAGF01 Function YES Cross-chassis HAG
  LME0FWF01 Function YES Firewall for SSU
  LME0P8200G00 Function YES SWCAP
  LME0BRAS01 Function YES BRAS Function(4k subscribers)
  LME0MDI00 Function YES DIST_MQE License
  LME0VPDN01 Function YES LNS&LTS Function
  LME0RDPXY00 Function YES Radius-proxy Function
  LME0LIF01 Function YES Lawful Interception
  LME0EPT00 Function YES RFC2544 Function
  LME0FPM00 Function YES IP FPM Function
  LME0SSGF01 Function YES DSG Function
  LME0WIFI00 Function YES ME60 Wifi Gateway Enhance Function License
  LME0REMMIR00 Function YES Remote Mirroring License
  LME0CONN01 Resource 256 Concurrent Users(1k)
  LME0SMVP00 Resource 32 EnhanceLicense_MVPN
  LME0STUN00 Resource 32 TUNNEL
  LME0SNAT00 Resource 32 NAT for SPU C
  LME0SNET00 Resource 32 ENHANCE_NS
  LME0VIDE00 Resource 32 MQE License
  LME0IPSEC00 Resource 32 IPSEC License
  LME0NATDS00 Resource 256 2M NAT Session
  LME0L2NATDS00 Resource 32 L2NAT license
  LME0DSLITEDS00 Resource 32 DS-lite license
  LME04020G00 Resource 32 20G NAT BandWidth
  LME0L2NAT01 Resource 32 L2NAT License for VSUF
  LME0DSLITE01 Resource 32 DS-Lite License for VSUF
  LME0PCP00 Resource 32 PCP License for VSUF
  LME0NAT6401 Resource 32 NAT64 License for VSUF
  LME0TUNL00 Resource 224 GTL license for Hybrid Access Tunnel
  LME0SGTN00 Resource 16 ME60 SoftGRE 1k Tunnel License
  
  Item name (View)Resource License Command-line
  -------------------------------------------------------------
  LME0IPSEC00 (License)active ipsec slot slot-id
  LME0NATDS00 (License)active nat session-table size
  LME0L2NATDS00 (License)active l2nat slot slot-id
  LME0DSLITEDS00 (License)active ds-lite slot slot-id
  LME04020G00 (License)active nat bandwidth-enhance slot slot-id
  LME0L2NAT01 (License)active l2nat vsuf slot slot-id
  LME0DSLITE01 (License)active ds-lite vsuf slot slot-id
  LME0PCP00 (License)active pcp vsuf slot slot-id
  LME0NAT6401 (License)active nat64 vsuf slot slot-id
  
  Master board license state: Normal.
  ```

- **应用场景3-设备使用B类型单板首次部署承载L3VPN业务**

  无

**风险的恢复方案**

同配置规范。

#### 1.10.1.2 CE双归组网中相同的VPN实例RD不能相同

CE双归到两个PE，BGP路由经过RR反射时两个PE上相同的VPN实例的RD建议配置为不同，否则会造成远端PE上只能看到一条路由，造成VPN FRR不生效。

##### 应用场景

如[图1-18](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_005001)所示，CE双归到PE1和PE2，相同VPN实例配置的RD相同，导致PE3上无法形成VPN FRR。

**图1-18** CE双归PE组网中RD相同导致VPN FRR不生效组网图
![img](.images/download)

##### 配置规范

两个PE上相同VPN实例配置不同的RD。

##### 非规范配置的风险

**风险描述**

如果主PE故障或者主PE与远端PE3之间的隧道故障，则PE3无法形成VPN FRR表项，无法触发VPN FRR切换，导致丢包超过秒级。

**风险的判断方法**

1. 查看PE1和PE2的配置，发现存在相同RD的VPN实例。

2. 在PE3上任意视图下执行**display ip routing-table vpn-instance** *vpn-instance-name ip-address* **verbose**命令，发现没有生成路由的备份下一跳，备份隧道和标签。说明在PE3上没有形成VPN FRR表项。

   ```
   <HUAWEI> display ip routing-table vpn-instance vpn1 10.1.1.0 verbose
   Route Flags: R - relay, D - download to fib
   ------------------------------------------------------------------------------
   Routing Table : vpn1
   Summary Count : 1
   
   Destination: 10.3.1.0/24
       Protocol: BGP            Process ID: 0
     Preference: 255                  Cost: 0
        NextHop: 2.2.2.2         Neighbour: 2.2.2.2
          State: Active Adv GotQ       Age: 00h15m06s
            Tag: 0                Priority: low
          Label: 15361             QoSInfo: 0x0
     IndirectID: 0x13
   RelayNextHop: 0.0.0.0         Interface: Pos2/0/0
       TunnelID: 0x6002002           Flags: RD
   ```

**风险的恢复方案**

两个PE上相同VPN实例配置不同的RD。

#### 1.10.1.3 取消接口与VPN实例的绑定关系导致联动删除BFD的配置

当取消接口与VPN实例的绑定关系时，之前与该接口存在联动关系的BFD会话会同时被联动删除，可能导致绑定到该BFD会话的静态路由的状态发生变化，造成业务受损。

##### 应用场景

如[图1-19](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_vrp_precaution_007101)所示：

1. 接口下配置**ip binding vpn-instance** *vpn-instance-name*命令绑定VPN实例。
2. 存在静态BFD会话绑定步骤1中的接口。
3. 存在静态路由绑定步骤2中的BFD会话，和BFD形成联动关系。

以上配置，当删除步骤1中接口下的**ip binding vpn-instance** *vpn-instance-name*命令时，会联动删除对应的BFD会话，BFD会话被删除时又会解除绑定到本会话的静态路由的联动关系，这样在某些场景下可能导致业务受损。

**图1-19** 取消接口与VPN实例的绑定关系导致联动删除BFD组网图
![img](.images/download)

Device1和Device2之间建立静态BFD会话，分别绑定GE1/0/0接口。

1. 在Device1上查询GE1/0/0的和BFD会话的配置。

   ```
   [Huawei] display current-configuration interface GigabitEthernet1/0/0
   #
   interface GigabitEthernet1/0/0
    ip binding vpn-instance vpn1   //绑定了VPN实例
    ip address 12.0.0.1 255.255.255.0
   #
   return
   ```

   ```
   [Huawei] display current-configuration configuration bfd-session 
   #
   bfd bfd1 bind peer-ip 12.0.0.2 vpn-instance vpn1 interface GigabitEthernet1/0/0
    discriminator local 1
    discriminator remote 2
    commit   //绑定了接口
   ```

2. Device1上查询BFD1会话状态。

   ```
   <HUAWEI> display bfd session all 
   --------------------------------------------------------------------------------
   Local Remote     PeerIpAddr      State     Type        InterfaceName            
   --------------------------------------------------------------------------------
   1     2          12.0.0.2        Up        S_IP_IF     GigabitEthernet1/0/0            
   --------------------------------------------------------------------------------
        Total UP/DOWN Session Number : 1/0
   ```

3. Device1上查询静态路由的配置和状态。

   ```
   [Huawei] display current-configuration  | include ip route 
   ip route-static 10.0.0.0 255.255.255.0 13.0.0.3 track bfd-session bfd1  //绑定了BFD会话
   ```

   静态路由活跃。

   ```
   [Huawei] display ip routing-table 10.0.0.1
   Route Flags: R - relay, D - download to fib
   ------------------------------------------------------------------------------
   Routing Table : Public
   Summary Count : 1
   Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface
   
          10.0.0.0/24  Static  60   0          RD   13.0.0.3        GigabitEthernet1/0/0
   ```

4. 当BFD1会话Down后，Device1上对应的静态路由撤销。

   ```
   [Huawei] display bfd session all
   --------------------------------------------------------------------------------
   Local Remote     PeerIpAddr      State     Type        InterfaceName            
   --------------------------------------------------------------------------------
   1     2          12.0.0.2        Down      S_IP_IF     GigabitEthernet1/0/0    //bfd会话down   
   -------------------------------------------------------------------------------
   ```

   ```
   [Huawei] display ip routing-table 10.0.0.1  //路由撤销
   ```

5. Device1上删除GigabitEthernet1/0/0接口下的**ip binding vpn-instance** *vpn-instance-name*命令。

   ```
   [Huawei-GigabitEthernet1/0/0] undo ip binding vpn-instance vpn1  //删除配置
   ```

   ```
   [Huawei] display current-configuration | include ip route
   ip route-static 10.0.0.0 255.255.255.0 13.0.0.3  //track bfd的配置被联动删除
   ```

   ```
   [Huawei] display ip routing-table 10.0.0.1      //路由重新活跃
   Route Flags: R - relay, D - download to fib
   ------------------------------------------------------------------------------
   Routing Table : Public
   Summary Count : 1
   Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface
   
          10.0.0.0/24  Static  60   0          RD   13.0.0.3        GigabitEthernet1/0/0
   ```

##### 配置规范

当取消接口与VPN实例的绑定关系时：

1. 如果之前存在BFD会话和该接口联动，则重新创建静态绑定接口的BFD会话。

   ```
   [Huawei]bfd bfd1 bind peer-ip 12.0.0.2 interface GigabitEthernet1/0/0
    discriminator local 1
    discriminator remote 2
    commit
   ```

2. 如果之前存在静态路由绑定该BFD会话，则需要再次将静态路由绑定到新创建的BFD会话。

   ```
   ip route-static 10.0.0.0 255.255.255.0 13.0.0.3 track bfd-session bfd1 
   ```

##### 非规范配置的风险

**风险描述**

去使能接口下VPN实例绑定命令，联动删除了BFD会话，而BFD会话删除又会解除静态路由和本BFD会话的联动关系，导致静态路由可能重新活跃，并迭代到错误的下一跳，导致业务受损。

**风险的判断方法**

1. 取消接口与VPN实例的绑定前，在任意视图下执行**display ip routing-table protocol** **static**命令，记录活跃的静态路由的详细情况。

   ```
   <HUAWEI> display ip routing-table  protocol static
   _public_ Routing Table : Static
   ```

2. 取消接口与VPN实例的绑定后，在任意视图下执行**display ip routing-table protocol** **static**命令，记录活跃的静态路由的详细情况。

   ```
   <HUAWEI> display ip routing-table protocol static
   _public_ Routing Table : Static
            Destinations : 1        Routes : 1        Configured Routes : 1         
   
   Static routing table status : <Active>
            Destinations : 1        Routes : 1         
   
   Destination/Mask    Proto   Pre  Cost        Flags NextHop         Interface
   
         100.0.0.0/24  Static  60   0             D   12.0.0.2        Ethernet0/1/0
   
   Static routing table status : <Inactive>
            Destinations : 0        Routes : 0
   ```

3. 对比取消接口与VPN实例的绑定前后静态路由，如果有新的静态路由活跃，并且是由于静态路由Track的BFD被联动删除导致其活跃，则存在风险。

**风险的恢复方案**

请按照配置规范进行配置。

## 1.11 安全

### 1.11.1 IPSec的配置规范

#### 1.11.1.1 多块VSUI-20-A部署IPSec双机热备场景下需要配置绑定保护组的VSU单板数门限值

默认情况，当设备上某一块VSUI-20-A单板故障时，此故障单板上的IPSec隧道需要到其他剩余的单板上重建，IPSec流量也将会负载分担到其他剩余的单板。如果IPSec业务量过大，可能会导致其他剩余的单板承载过多流量，影响其他剩余的单板上的IPSec业务。故障单板恢复正常后，业务也不回切，造成IPSec业务板间负载分担不均。

##### 应用场景

如下图所示，Network1和Network2通过插有VSUI-20-A单板的DeviceA1、DeviceA2、DeviceB设备建立IPSec隧道穿越网络进行互访，IPSec业务量十分大。DeviceA1、DeviceA2部署IPSec框间备份，DeviceA1、DeviceA2与Network1互联口部署VRRP。DeviceA1、DeviceA2上分别有3块VSUI-20-A单板绑定在保护组内以负载分担方式承载IPSec业务。

![img](.images/download)

##### 配置规范

配置IPsec双机热备主备倒换时绑定保护组的VSUI-20-A单板数量的门限值，并且门限值必须配置成绑定保护组的VSUI-20-A单板数量减1，即当1块VSUI-20-A单板故障后，设备立即实现框间主备倒换。

- IPsec实例视图下，执行命令**hrp least active-slot-number** *slot-number*，*slot-number*值为绑定的VSUI-20-A单板数减1。*slot-number*的默认值为0，因此当绑定的单板数为1时，无需配置。

详情参考：（可选）配置IPsec双机热备。

##### 非规范配置的风险

**风险描述**

默认情况，当设备上某一块VSUI-20-A单板故障时，此故障单板上的IPSec隧道需要到其他剩余的单板上重建，IPSec流量也将会负载分担到其他剩余的单板。如果IPSec业务量过大，可能会导致其他剩余的单板承载过多流量，影响其他剩余的单板上的IPSec业务。故障单板恢复正常后，业务也不回切，造成IPSec业务板间负载分担不均。

![img](.images/download)

**风险的判断方法**

在用户视图下，通过**display current-configuration configuration** *configuration-type*查看IPSec实例的配置。“hrp least active-slot-number”字段的显示值需要为“bind slot”字段数量减1，例如下述回显中，绑定VSU单板数是2，配置的门限值是1，不存在风险。

```
[HUAWEI] display current-configuration configuration ipsec-instance
#
ipsec instance 6
 hrp peer 10.0.1.2 
 hrp track interface GigabitEthernet3/0/7
 hrp vrrp vrid 1 interface GigabitEthernet3/0/11
bind slot 2 backup-id 1
bind slot 3 backup-id 2
 hrp least active-slot-number 1
#
Return
```

**风险的恢复方案**

同配置规范。

#### 1.11.1.2 IPSec业务场景下需要配置IKE DPD保证IPSec隧道两端状态一致

DPD使用IPsec流量来最小化peer状态检测所需消息报文的数量，此机制不使用周期发送消息的机制。此机制是IKE存活机制的一种替代机制。部署IPSec业务时，必须配置IKE DPD，从而IPSec隧道两端发送报文感知对端状态，保证两端IPSec隧道状态一致和IPSec业务转发的正常运行。

##### 应用场景

如下图所示，DeviceA设备和DeviceB设备之间部署IPSec隧道穿越Internet，Network1与Network2通过此隧道互访。

![img](.images/download)

##### 配置规范

通过命令行**ike dpd**配置DPD功能。详见：（可选）配置IKE对等体检测功能。

##### 非规范配置的风险

**风险描述**

当IPSec隧道两端状态不一致时，IPSec流量无法即时删除重建，将会出现黑洞，IPSec业务转发报文不通。

**风险的判断方法**

在用户视图下，通过**display current-configuration | include ike dpd**查看是否配置了**ike dpd**，如果没有回显，则未配置ike dpd。

```
[HUAWEI] display current-configuration | include ike dpd
 ike dpd 30       
```

**风险的恢复方案**

同配置规范。

#### 1.11.1.3 IPSec双机热备场景下主备IPSec设备之间链路的MTU值需要配置大于2000

##### 应用场景

如下图所示，IPSec双机热备场景下，IPSec双机设备之间有直连的接口相连接，部署HRP业务。

IPSec隧道下应用了安全策略组并绑定了IPSec实例（在IPSec隧道视图下，执行了命令**ipsec policy** *policy-name* **instance** *instance-id*），并且IPsec安全提议配置传送数据时采用的安全协议是**ah-esp**（在安全提议视图下，执行了命令**transform** **ah-esp**，配置传送数据时采用的安全协议，先使用ESP协议对报文进行保护，再使用AH协议对报文进行保护）。

![img](.images/download)

##### 配置规范

需要将用来备份数据的本端接口（即通过命令**hrp track interface** *interface-type* *interface-number*配置的接口）的MTU值设置为大于或等于2000，请根据本端接口的类型选择以下配置方式：

- 本端接口类型为GE接口时，在GE接口视图下执行**mtu** *mtu*命令，设置GE接口的MTU值。
- 本端接口类型为Eth-Trunk接口时，在Eth-Trunk接口视图下执行**mtu** *mtu*命令，设置Eth-Trunk接口的MTU值。

##### 非规范配置的风险

**风险描述**

IPSec双机热备场景下主备IPSec设备之间链路的MTU值如果小于2000，会导致IPSec SA信息备份失败，主备倒换后业务中断。

**风险的判断方法**

1. 在用户视图下，通过

   display ipsec proposal

   查看配置传送数据时采用的安全协议是否为

   ah-esp-new

   。如果有，说明配置传送数据时采用的安全协议是先使用ESP协议对报文进行保护，再使用AH协议对报文进行保护。

   ```
   <HUAWEI> display ipsec proposal
   ```

   ```
     IPsec proposal name: 1
       encapsulation mode: tunnel
       transform: ah-esp-new
       AH protocol: authentication md5-hmac-96
       ESP protocol: not use authentication, encryption des
   ```

2. 确认备份链路的接口。在用户视图下，通过

   display current-configuration configuration ipsec-instance

   ，确定备份数据的本端接口。

   ```
   #                                                                                                                                   
   ipsec instance 1                                                                                                                    
    hrp peer 20.30.40.2                                                                                                                
    hrp track interface GigabitEthernet1/0/1                                                                                          
    hrp vrrp vrid 1 interface GigabitEthernet1/0/1.1                                                                                  
    bind slot 2 backup-id 1  
   ```

3. 以GE接口为例：在用户视图下，通过

   display interface gigabitethernet

   interface-number

   ，查看接口的MTU值。

   ```
   <HUAWEI> display interface GigabitEthernet 1/0/1
   ```

   ```
   GigabitEthernet1/0/1 current state : DOWN
   Line protocol current state : DOWN
   Link quality grade : --
   Description:HUAWEI, GigabitEthernet1/0/1 Interface
   Route Port,The Maximum Transmit Unit is 1500
   Internet protocol processing : disabled
   IP Sending Frames' Format is PKTFMT_ETHNT_2, Hardware address is 00e0-fc7b-9c00
   The Vendor PN is TXN132241013AS3
   BW: 10G, Transceiver Mode: SingleMode
   WaveLength: 1310nm, Transmission Distance: 10km
   RX Power: -19.75dBm, TX Power: -3.51dBm
   Media type: fiber ,loopback: none , Scramble enabled, clock master , WAN full-du
   plex mode ,Pause Flowcontrol:Receive Enable and Send Enable
   Flag J0 ""
   Flag J1 ""
   Flag C2 26(0x1a)
   Last physical up time   : -
   Last physical down time : 2000-03-17 20:09:54 UTC+08:00
   Current system time: 2000-04-03 15:28:35+08:00
   Statistics last cleared:never
       Last 300 seconds input rate: 0 bits/sec, 0 packets/sec
       Last 300 seconds output rate: 0 bits/sec, 0 packets/sec
       Input: 0 bytes, 0 packets
       Output: 0 bytes, 0 packets
       Input:
         Unicast: 0 packets, Multicast: 0 packets
         Broadcast: 0 packets, JumboOctets: 0 packets
         CRC: 0 packets, Symbol: 0 packets
         Overrun: 0 packets, InRangeLength: 0 packets
         LongPacket: 0 packets, Jabber: 0 packets
         Fragment: 0 packets, Undersized Frame: 0 packets
         RxPause: 0 packets
       Output:
         Unicast: 0 packets, Multicast: 0 packets
         Broadcast: 0 packets, JumboOctets: 0 packets
         System: 0 packets, Overrun: 0 packets
         TxPause: 0 packets
         Unknown Vlan: 0 packets
       Input bandwidth utilization  :    0%
       Output bandwidth utilization :    0%
   ```

**风险的恢复方案**

同配置规范。

### 1.11.2 URPF的配置规范

#### 1.11.2.1 多路负载分担场景下需要配置URPF对匹配缺省路由的报文进行转发处理

##### 应用场景

如下图所示，用户通过Device A与ISP聚合设备（Device B）连接，在Device A的上行接口配置URPF，可以保护ISP设备和Internet其他部分免受来自客户网络的源地址欺骗攻击。

![img](.images/download)

##### 配置规范

在ISP聚合设备（Device B）上配置流量策略，允许指定网段的流量通过URPF检查。详见：配置基于复杂流分类的流量策略。

在Device A的上行接口上，执行命令**ip urpf strict allow-default**，配置URPF对匹配缺省路由的报文进行转发处理功能。

##### 非规范配置的风险

**风险描述**

多路负载分担场景下，如果未配置URPF对匹配缺省路由的报文进行转发处理，将会导致业务中断。

**风险的判断方法**

在用户视图下，通过**display current-configuration interface**，查看URPF配置，如配置不为**ip urpf strict allow-default**则存在风险。

```
#                                                                               
interface GigabitEthernet1/0/1                                                  
 undo shutdown                                                                  
 ip address  192.168.1.1                                                                                           
 ip urpf loose                                                    
#                    
……
```

**风险的恢复方案**

同配置规范。

## 1.12 用户接入

### 1.12.1 地址管理配置规范

#### 1.12.1.1 限制DHCP用户连接请求防止业务繁忙影响正常用户上线

##### 应用场景

如果网络上存在大量无效的连接请求报文或者Discover攻击报文，可能造成业务繁忙，严重时可能影响正常用户上线。

DHCP用户上线场景，组网如下图所示。

![img](.images/download)

##### 配置规范

为防止因业务繁忙严重时可能影响正常用户上线的情况出现，可以在系统视图下配置**dhcp connection chasten** { **authen-packets** *authen-packets* | **request-packets** *request-packets* } * **check-period** *check-period* **restrain-period** *restrain-period* [ **slot** *slotid* ]，设置合理的参数可以限制攻击报文缓解业务压力。

##### 非规范配置的风险

**风险描述**

案例：设备上配置**dhcp connection chasten request-packets \*3\* check-period \*60\* restrain-period \*180\***，1分钟内收到请求报文（Discover报文或Request报文）超过3个，则抑制该用户的报文3分钟。抑制报文时间为180秒配置的不合理，导致正常的DHCP用户上线慢。

**风险的判断方法**

执行命令**display current-configuration**查询所有的配置信息，查看是否有**dhcp connection chasten**配置。

```
<HUAWEI> display current-configuration                                                                                                  
#
dhcp connection chasten request-packets 3 check-period 60 restrain-period 180
#
…
```

**风险的恢复方案**

有两种恢复方案：

1. 在系统视图下执行命令**undo dhcp connection chasten**删除DHCP用户上线请求连接限制。
2. 根据现网情况合理调整配置限制DHCP用户请求连接的参数值。

#### 1.12.1.2 RUI用户触发上线获取的地址不是域下地址池范围内的地址

##### 应用场景

RUI主机用户上线后，设备ARP探测失败导致用户下线。用户下线后，设备删除了原有的地址池，重新配置新地址池。

##### 配置规范

无。

##### 非规范配置的风险

**风险描述**

RUI用户再次触发上线，获取到的地址不是新配置的地址池范围内的地址。

**风险的判断方法**

无。

**风险的恢复方案**

RUI用户触发上线获取的地址不是域下地址池范围内的地址，需要重启客户端重新获取地址，或者等地址租期到期且续租不成功。客户下线后重新上线就能获取到新配置的地址池范围内的地址。

### 1.12.2 WLAN无线漫游场景的参数配置规范

#### 应用场景

AC和AP中间为二层网络的组网方式场景。数据直接转发组网如[图1-20](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_ne_precaution_0009)所示：

**图1-20** 数据直接转发组网
![img](.images/download)

#### 配置规范

WLAN无线漫游场景，如果终端的物理位置信息发生变化（MAC地址不变），终端重新发起DHCP上线请求或ND上线请求。可根据现网需要决定是否配置**dhcp session-mismatch action offline**、**dhcp session-mismatch action roam ipv4**命令。

如果现网需要立即感知终端用户状态变化,则可以通过配置**dhcp session-mismatch action offline**命令，触发已在线用户下线，再重新上线。

如果现网需要在用户业务不中断的情况下，处理物理位置信息变化的DHCP请求报文，则可以配置**dhcp session-mismatch action roam ipv4**命令。

#### 非规范配置的风险

**风险描述**

终端用户在两个非邻接热点漫游或者手动切换SSID时，会引起终端的物理位置信息发生变化（MAC地址不变），终端重新发起DHCP上线请求。 由于物理位置信息变化，MAC地址不变，设备会认为终端重新发起的DHCP上线请求报文或ND上线请求报文为攻击报文，将DHCP上线请求报文或ND上线请求报文丢弃，这时设备认为终端用户还在线，但终端用户可能已经下线，设备不能立即感知到终端用户已下线，导致终端用户不能快速上线。

#### 风险的判断方法

在任意视图，执行命令**display current-configuration interface**，查看BAS接口配置。如果BAS接口视图下仅配置了用户接入方式，但未配置**dhcp session-mismatch action offline**、**dhcp session-mismatch action roam ipv4**命令，则可能存在问题。

1. ```
   <HUAWEI> system-view
   ```

   ```
   [HUAWEI] interface GigabitEthernet2/0/0.77
   ```

   ```
   [HUAWEI-GigabitEthernet2/0/0.77] bas
   ```

   ```
   [HUAWEI-GigabitEthernet2/0/0.77-bas] access-type layer2-subscriber
   ```

   ```
   [HUAWEI-GigabitEthernet2/0/0.77-bas] dhcp session-mismatch action offline  
   ```

   配置影响

   缺省情况下，物理位置信息发生变化、MAC地址不变的已在线用户重新发起DHCP上线请求或ND上线请求时，不会触发已在线用户下线。

   配置了**dhcp session-mismatch action offline**命令后，当终端再发起DHCP上线请求或ND上线请求时，会触发终端用户下线，当终端继续发起DHCP上线请求或ND上线请求时，使用户重新上线，这样用户就能较快速地上线。

   ![img](.images/download) **说明：**

   执行该命令后，如果攻击源伪造MAC地址信息发起DHCP上线请求或ND上线请求时，会导致正常在线用户掉线，可能导致安全隐患，请谨慎使用。

2. 执行命令**dhcp session-mismatch action roam ipv4**用来指定WLAN用户从别的接口漫游到此接口时，可以由此接口收到的用户DHCP discover或request报文触发用户的漫游处理，用户能够不认证，直接再次联接网络。

   ```
   [HUAWEI] interface GigabitEthernet2/0/0.77  
   ```

   ```
   [HUAWEI-GigabitEthernet2/0/0.77] bas
   ```

   ```
   [HUAWEI-GigabitEthernet2/0/0.77-bas] access-type layer2-subscriber
   ```

   ```
   [HUAWEI-GigabitEthernet2/0/0.77-bas] dhcp session-mismatch action roam ipv4 
   ```

   **配置影响**

   缺省情况下，在设备存在用户的情况下，收到用户物理位置信息变化的DHCP请求报文时，会将请求报文直接丢弃，不处理。 配置了dhcp session-mismatch action roam ipv4命令后，会处理物理位置信息变化了的DHCP请求报文，将用户原来的IP地址回应给用户，然后切换用户在设备上的物理位置，保证用户业务不中断。

   ![img](.images/download) **说明：**

   执行该命令后，如果攻击源伪造MAC地址信息发起DHCP上线请求，会导致正常在线用户流量被切换到攻击源，而正常用户无法联接网络，可能导致安全隐患，请谨慎使用。

### 1.12.3 一MAC多Session用户接入场景错误案例

#### 应用场景

同一MAC的用户分别从两个Eth-Trunk接口上线（Eth-Trunk1同板Trunk，Eth-Trunk2跨板Trunk，两个Trunk口有相同的板）。

**图1-21** 一MAC多Session用户上线接入示意图
![img](.images/download)

#### 问题描述

用户现在Eth-Trunk 1(同板Trunk，1号板)上上线，之后又从Eth-Trunk2的2号板上线，一MAC多Session在接口板有限制，所以从Eth-Trunk2上线的在1号板无法生成PPP表，之后Eth-Trunk2的用户从1号板收到echo reply报文，转给2号单板，连续3次后，设备认为主处理板应该切换为1号单板。进行单板切换，但是1号板没有ppp表，用户下线，LPUF-20/21(灵活插卡）、LPUS-20(固定单板）下线原因为UCM failed to update work-slot of trunk-interface user，LPUF-120/LPUF-120-B/LPUF-120-E/LPUF-102/LPUF-102-E(灵活插卡）、LPUI-120/LPUI-120-B/LPUI-102-E/LPUS-120(固定单板）下线原因为 PPP echo fail。

### 1.12.4 WEB用户上线ACL配置规范

#### 应用场景

用户通过Web认证方式上线。

**图1-22** WEB用户上线组网图
![img](.images/download)

#### 配置规范

1. ACL视图下执行命令**rule** *rule-id* **permit ip source user-group web-before destination ip-address** *ip-address* 配置用户前域访问权限允许用户访问部分IP地址，并在traffic classifier视图下绑定该ACL规则。
2. ACL视图下执行命令**rule** *rule-id* **permit tcp source user-group web-before destination-port eq www**配置ACL规则匹配TCP报文，并在traffic behavior视图下配置**http-redirect**命令，对前域不允许访问的IP地址一律强推HTTP。

#### 非规范配置的风险

**风险描述**

流行为视图下配置**http-reply enable**使能Web增强快回，同时执行命令**rule** *rule-id* **permit tcp source user-group web-before**配置简化的ACL规则。

则当用户的报文匹配该简化规则时，就会进行快回操作。用户报文会在单板上环回转发，耗尽单板资源会导致整板业务受损，用户频繁掉线。

#### 风险的恢复方案

删除简化规则的配置，按照配置规范配置ACL规则。

## 1.13 增值业务

### 1.13.1 DAA的配置规范

#### 1.13.1.1 对配置了DAA业务的用户做NAT地址转换必须在业务模板下绑定正确的VPN实例

##### 应用场景

用户上线后需要做NAT地址转换，同时配置了DAA增值业务，却没有在DAA业务模板下绑定正确的VPN实例。

##### 配置规范

1. 如果用户确认需要配置DAA，DAA业务模板下配置的user-group必须绑定正确的VPN实例。
2. 如果用户不需要增值业务，则在AAA域下执行命令行**undo value-added-service policy（AAA域视图）** 删除DAA模板配置。

##### 非规范配置的风险

**风险描述**

用户流量匹配了DAA业务模板定义的规则，由于DAA业务模板中未绑定正确的VPN，导致无法引流到CGN单板，用户报文被丢弃。

**风险的判断方法**

在用户视图下，通过**display value-added-service user user-id** *used-id* 查看用户是否携带增值业务。如果有”The used VAS service id table are”回显，则说明用户配置了DAA业务。

```
<HUAWEI> display value-added-service user user-id 0
------------------------------------------------------------------------
 User access index           : 0
 State                       : Used
 User name                   : 0000000000ad@zw
 User service number         : 1
 COPS server name            : --
 DAA rate limit mode outbound: --
 -------------------------------------------------------------------------
 The used VAS service id table are:
 (     0,    1) 
 -------------------------------------------------------------------------
 -------------------------------------------------------------------------
```

**风险的恢复方案**

1. 针对配置规范场景1：按照配置规范操作。
2. 针对配置规范场景2：如果用户已经上线激活了DAA业务，而实际用户不需要DAA业务，则在AAA域下执行命令行**undo value-added-service policy（AAA域视图）** 删除DAA模板配置，用户重新上线即可。

## 1.14 IPv6过渡技术

### 1.14.1 CGN的配置规范

#### 1.14.1.1 CGN需要配置冗余备份

使用VSUF单板或者VSUI单板配置CGN业务时，如果未配置冗余备份，当单板发生故障时，该单板上承载的用户无法访问网络。为了避免此类现象发生，需要部署多块VSUF/VSUI单板，并配置CGN业务冗余备份。

##### 应用场景

如[图1-23](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#dc_ne_precaution_0003_6_mMcCpPsS_fig_dc_ne_precaution_000301)所示，用户通过插有VSUF单板或者VSUI单板的Device A进行CGN转换后访问网络。

**图1-23** 用户通过Device A进行CGN转换后访问网络组网图
![img](.images/download)

或者，如[图1-24](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#dc_ne_precaution_0003_6_mMcCpPsS_fig_dc_ne_precaution_000302)所示，用户通过插有VSUF单板或者VSUI单板的Device A和Device B进行CGN转换后访问网络。

**图1-24** 用户通过Device A和Device B进行CGN转换后访问网络组网图
![img](.images/download)

##### 配置规范

使用VSUF单板或者VSUI单板配置CGN业务时，需要部署多块VSUF单板或者VSUI单板，对CGN业务进行冗余备份。具体配置方法请参考：

- 配置NAT单机板间热备功能（VSUF-40/80/160、VSUI-160-E业务板）
- 配置NAT双机框间热备功能（VSUF-40/80/160、VSUI-160-E业务板）
- 配置NAT单机板间热备功能（VSUI-20-A业务板）

##### 非规范配置的影响

**风险描述**

当配置CGN业务的单板发生故障无法使用时，该单板承载的CGN用户无法访问网络。

**风险的判断方法**

对于VSUF单板，当前CGN业务的冗余备份方式分为板间备份和框间备份两种，判断风险的方法具体如下：

- 板间备份的风险判断方法如下：

  1. 在用户视图下，通过**display device**或**display version slot** *slot-id*命令查看至少有两块VSUF单板。

     ```
     <HUAWEI> display device
     Devicename-X8's Device status:
     Slot #    Type       Online    Register      Status      Primary    
     - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     1         LPU        Present   Registered    Normal      NA         
     2         LPU        Present   Registered    Normal      NA         
     5        VSU      Present   Registered    Normal      NA         
     8        VSU      Present   Registered    Normal      NA         
     9         MPU        Present   NA            Normal      Master     
     10        MPU        Present   Registered    Normal      Slave      
     11        SFU        Present   Registered    Normal      NA         
     12        SFU        Present   Registered    Normal      NA         
     13        SFU        Present   Registered    Normal      NA         
     14        CLK        Present   Registered    Normal      Master     
     15        CLK        Present   Registered    Normal      Slave      
     16        PWR        Present   Registered    Abnormal    NA         
     17        PWR        Present   Registered    Normal      NA         
     18        FAN        Present   Registered    Normal      NA         
     19        FAN        Present   Registered    Normal      NA 
     ```

     ```
     <HUAWEI> display version slot 5
     VSU 5  : uptime is 2 days, 16 hours, 49 minutes
              StartupTime   2002/07/12   21:46:09 
       Host    processor :
       SDRAM Memory Size: 4096M  bytes
       Flash Memory Size:  128M  bytes
       VSU version information
       PCB         Version : CR57VSUF80 REV B
       EPLD        Version : 109
       EPLD2       Version : 106
       EPLD3       Version : 102
       BootROM     Version : 2.30
       BootLoad    Version : 2.19
       FSURTP      Version : Version 2.1 RELEASE 0372
       FSUKERNEL   Version : Version 2.1 RELEASE 0372
       ASE         Version : 009
       MonitorBUS version information:
       Software    Version : 10.51
       Configure license items:
       2M NAT Session License
     ```

     ```
     <HUAWEI> display version slot 8
     VSU 8  : uptime is 0 day, 18 hours, 27 minutes
              StartupTime   2006/07/14   17:13:48 
       Host    processor :
       SDRAM Memory Size: 4096M  bytes
       Flash Memory Size:  128M  bytes
       VSU version information
       PCB         Version : CR57VSUF160 REV B
       EPLD        Version : 109
       EPLD2       Version : 106
       EPLD3       Version : 102
       BootROM     Version : 2.30
       BootLoad    Version : 2.19
       FSURTP      Version : Version 2.1 RELEASE 0372
       FSUKERNEL   Version : Version 2.1 RELEASE 0372
       ASE         Version : 009
       MonitorBUS version information:
       Software    Version : 10.51
       Configure license items:
       2M NAT Session License                  
       20G NAT BandWidth License
     ```

  2. 在用户视图下，通过**display nat instance**命令查看其绑定的**service-location**，再使用**display service-location** [ *service-location-id* ]命令查看是否有**Backup slot ID**字段，如果有，则有板间备份保护；如果没有，则没有板间备份保护。

     ```
     <HUAWEI> display nat instance
     nat instance dtest id 22
      port-range 4096
      service-instance-group dtest 
      nat address-group dtest group-id 22
        section 0 100.100.100.0 mask 255.255.255.0
      nat outbound 2222 address-group dtest
     ```

     ```
     <HUAWEI> display service-location
     service-location 58
      Location slot ID: 5 engine ID: 0
      Current location slot ID: 5 engine ID: 0
      Backup slot ID: 8 engine ID: 0
      Current backup slot ID: 8 engine ID: 0
      Bound service-instance-group number: 1
      Batch-backup state: finished
     ```

- 框间备份的风险判断方法如下：

  在用户视图下，通过**display nat instance**命令查看其绑定的**service-location**，再使用**display service-location** [ *service-location-id* ]命令查看是否有**Remote-backup interface**字段，如果有，则有框间备份保护；如果没有，则没有框间备份保护。

  ```
  <HUAWEI> display service-location 22
  service-location 22
   Backup scene type: inter-box
   Location slot ID: 5 engine ID: 0
   Remote-backup interface: GigabitEthernet2/2/1.1
   Peer: 22.255.255.2
   Vrrp ID: 22 
   Vrrp bind interface: GigabitEthernet2/2/1.1
   Vrrp state: master
   Bound service-instance-group number: 1
   Batch-backup state: finished
  ```

对于VSUI单板，风险判断方法如下：

1. 在用户视图下，通过**display device**命令查看至少两块VSUI单板。

   ```
   <HUAWEI> display device
   Devicename-X8's Device status:
   Slot #    Type       Online    Register      Status      Primary    
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   1         LPU        Present   Registered    Normal      NA         
   2        VSU      Present   Registered    Normal      NA         
   3        VSU      Present   Registered    Normal      NA         
   4         LPU        Present   Registered    Normal      NA         
   5         TSU        Present   Registered    Normal      NA         
   6         TSU        Present   Registered    Normal      NA         
   8         LPU        Present   Registered    Normal      NA         
   10        MPU        Present   NA            Normal      Master     
   11        SFU        Present   Registered    Normal      NA         
   13        SFU        Present   Registered    Normal      NA         
   15        CLK        Present   Registered    Normal      Master     
   16        PWR        Present   Registered    Normal      NA         
   17        PWR        Present   Registered    Normal      NA         
   18        FAN        Present   Registered    Normal      NA         
   19        FAN        Present   Registered    Normal      NA 
   ```

   ```
   <HUAWEI> display device 2
    slot2's detail information:
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     Description: Integrated Versatile Service Unit 20 A(VSUI-20-A)
     Board status:       Normal
     Register:           Registered 
     Uptime:             2012/07/13    11:49:55
   Clock information:
     State item          State               
     Current syn-clock:  10                  
     Syn-clock state:    Locked     VCXO_OK    REF_OK     
     Syn-clock 9 state:  Inactived           
     Syn-clock 10 state: Actived             
   Statistic information:
     Statistic item      Statistic number
     SERDES interface link lost:             0                   
     MPU switches:       0
     Syn-clock switches: 1                   
   CPU0 information:
     CPU Online:         Present
     CPU Register:       Registered
     CPU SDRAM Memory Size:                  4G
     CPU Utilization(%): 33%
     CPU Mem Usage(%):   28%
     VCPU Utilization
     VCPU0  :33%  VCPU1  :3 %  VCPU2  :3 %  VCPU3  :0 %
     VCPU4  :0 %  VCPU5  :0 %  VCPU6  :0 %  VCPU7  :0 %
     VCPU8  :0 %  VCPU9  :0 %  VCPU10 :0 %  VCPU11 :0 %
     VCPU12 :0 %  VCPU13 :0 %  VCPU14 :0 %  VCPU15 :0 %
     VCPU16 :0 %  VCPU17 :0 %  VCPU18 :0 %  VCPU19 :0 %
     VCPU20 :0 %  VCPU21 :0 %  VCPU22 :0 %  VCPU23 :0 %
     VCPU24 :0 %  VCPU25 :0 %  VCPU26 :0 %  VCPU27 :0 %
     VCPU28 :0 %  VCPU29 :0 %  VCPU30 :0 %  VCPU31 :0 %
   CPU1 information:
     CPU Online:         Present
     CPU Register:       Registered
     CPU SDRAM Memory Size:                  4G
     CPU Utilization(%): 28%
     CPU Mem Usage(%):   27%
     VCPU Utilization
     VCPU0  :28%  VCPU1  :3 %  VCPU2  :3 %  VCPU3  :0 %
     VCPU4  :0 %  VCPU5  :0 %  VCPU6  :0 %  VCPU7  :0 %
     VCPU8  :0 %  VCPU9  :0 %  VCPU10 :0 %  VCPU11 :0 %
     VCPU12 :0 %  VCPU13 :0 %  VCPU14 :0 %  VCPU15 :0 %
     VCPU16 :0 %  VCPU17 :0 %  VCPU18 :0 %  VCPU19 :0 %
     VCPU20 :0 %  VCPU21 :0 %  VCPU22 :0 %  VCPU23 :0 %
     VCPU24 :0 %  VCPU25 :0 %  VCPU26 :0 %  VCPU27 :0 %
     VCPU28 :0 %  VCPU29 :0 %  VCPU30 :0 %  VCPU31 :0 %
   CPU2 information:
     CPU Online:         Present
     CPU Register:       Registered
     CPU SDRAM Memory Size:                  4G
     CPU Utilization(%): 29%
     CPU Mem Usage(%):   27%
     VCPU Utilization
     VCPU0  :29%  VCPU1  :3 %  VCPU2  :3 %  VCPU3  :0 %
     VCPU4  :0 %  VCPU5  :0 %  VCPU6  :0 %  VCPU7  :0 %
     VCPU8  :0 %  VCPU9  :0 %  VCPU10 :0 %  VCPU11 :0 %
     VCPU12 :0 %  VCPU13 :0 %  VCPU14 :0 %  VCPU15 :0 %
     VCPU16 :0 %  VCPU17 :0 %  VCPU18 :0 %  VCPU19 :0 %
     VCPU20 :0 %  VCPU21 :0 %  VCPU22 :0 %  VCPU23 :0 %
     VCPU24 :0 %  VCPU25 :0 %  VCPU26 :0 %  VCPU27 :0 %
     VCPU28 :0 %  VCPU29 :0 %  VCPU30 :0 %  VCPU31 :0 %
   CPU3 information:
     CPU Online:         Present
     CPU Register:       Registered
     CPU SDRAM Memory Size:                  4G
     CPU Utilization(%): 29%
     CPU Mem Usage(%):   27%
     VCPU Utilization
     VCPU0  :29%  VCPU1  :3 %  VCPU2  :3 %  VCPU3  :0 %
     VCPU4  :0 %  VCPU5  :0 %  VCPU6  :0 %  VCPU7  :0 %
     VCPU8  :0 %  VCPU9  :0 %  VCPU10 :0 %  VCPU11 :0 %
     VCPU12 :0 %  VCPU13 :0 %  VCPU14 :0 %  VCPU15 :0 %
     VCPU16 :0 %  VCPU17 :0 %  VCPU18 :0 %  VCPU19 :0 %
     VCPU20 :0 %  VCPU21 :0 %  VCPU22 :0 %  VCPU23 :0 %
     VCPU24 :0 %  VCPU25 :0 %  VCPU26 :0 %  VCPU27 :0 %
     VCPU28 :0 %  VCPU29 :0 %  VCPU30 :0 %  VCPU31 :0 %
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   ```

2. 在用户视图下，通过**display nat instance**命令查看配置，是否有“add slot x slave”或者“nat address-group xxx rui-slave metric xx”字段，如果有其一，则说明CGN业务配置了冗余备份；如果都没有，则无冗余备份。

   ```
   <HUAWEI> display nat instance
   nat instance nat444-1
    nat filter mode full-cone
    port-range 4096
    add slot 2 master
    add slot 3 slave
    nat address-group addressgroup1
     section 0 182.148.135.0 mask 24
    nat outbound 2080 address-group addressgroup1
   ```

**风险的恢复方案**

同配置规范。

#### 1.14.1.2 CGN场景port-range参数配置规范

NAT实例下，端口预分配的范围port-range配置为1024，NAT地址池的转换模式采用五元组，部分用户打开网站时由于端口不够用，NAT session无法建立。

##### 应用场景

如[图1-25](https://support.huawei.com/enterprise/zh/doc/EDOC1000124120?idPath=24030814|9856750|22715517|9858933|15837&section=j003#fig_dc_ne_nat_cfg_0001)所示，在分布式CGN场景中，CPE拨号到BRAS（BRAS集成CGN功能）上线，BRAS为CPE分配上线地址以及对应NAT地址和端口段。当终端用户对外发起访问时，CPE对用户PC发出报文进行一次NAT转换，BRAS对CPE发出报文做第二次转换。因为网络中存在两次地址转换，同时由于CGN功能分布在各个BRAS接入点。

**图1-25** 基于端口预分配的分布式NAT444解决方案示意图
![img](.images/download)

##### 配置规范

在NAT/DS-Lite/NAT64实例下，为了防攻击，需要通过命令**port-range**配置端口预分配功能。配了端口预分配后，对于某个用户使用的端口数是固定的。为了节省端口及P2P等应用的需要，同时需要将NAT地址池的转换模式配置为三元组。

在NAT/DS-Lite/NAT64实例下配置端口预分配的范围，现网部署NAT时端口预分配的范围至少是2048，如果低于该值，就需要配置端口半动态分配模式。以NAT实例为例，端口预分配配置规范如下：

1. 配置端口分配方式。采用两种模式，如下所示：

   - 以端口预分配方式配置，配置如下:

     ```shell
     nat instance nat444-rui id 1                                                                                                        
      port-range 4096  
     ```

   - 以端口半动态分配方式配置，并且需要在实例下使能三元组模式，配置如下：

     ```shell
     nat instance nat444-rui id 1                                                                                                        
      port-range 1024 extended-port-range 1024 extended-times 1
     ```

2. 实例下配置三元组。

   ```
   nat instance nat444-rui id 1                                                                                                                                                                                                                                                                                                                                                
    nat filter mode full-cone
   ```

##### 非规范配置的影响

**风险描述**

执行命令**port-range**配置端口预分配范围*initial-port-range*低于2048，并且实例下采用五元组时，部分用户打开网站时由于端口不够用，NAT session无法建立。

**风险的判断方法**

1. 在任意视图下，执行命令**display nat instance**或者**display ds-lite instance**或者**display nat64 instance**查看实例配置。通过**port-range**判断端口预分配的范围是否低于2048。

2. 在实例视图下，执行命令**display this**查看实例下是否配置了三元组模式。

   端口预分配的范围低于2048，且实例下没有配置三元组模式会导致部分用户打开网站时由于端口不够用，NAT session无法建立。

**风险的恢复方案**

在实例下执行命令**port-range** *initial-port-range*将端口预分配的范围调整到2048及以上，并且实例下执行命令**nat filter mode full-cone**配置NAT地址池的转换模式为三元组。